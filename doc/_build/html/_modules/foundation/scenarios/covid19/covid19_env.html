<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>foundation.scenarios.covid19.covid19_env &mdash; ai-economist foundation  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> ai-economist foundation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">foundation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ai-economist foundation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../../foundation.html">foundation</a> &raquo;</li>
      <li>foundation.scenarios.covid19.covid19_env</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for foundation.scenarios.covid19.covid19_env</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2021, salesforce.com, inc.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: BSD-3-Clause</span>
<span class="c1"># For full license text, see the LICENSE file in the repo root</span>
<span class="c1"># or https://opensource.org/licenses/BSD-3-Clause</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">GPUtil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">ai_economist.foundation.base.base_env</span> <span class="kn">import</span> <span class="n">BaseEnvironment</span><span class="p">,</span> <span class="n">scenario_registry</span>
<span class="kn">from</span> <span class="nn">ai_economist.foundation.utils</span> <span class="kn">import</span> <span class="n">verify_activation_code</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">num_gpus_available</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GPUtil</span><span class="o">.</span><span class="n">getAvailable</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inside covid19_env.py: </span><span class="si">{</span><span class="n">num_gpus_available</span><span class="si">}</span><span class="s2"> GPUs are available.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_gpus_available</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPUs found! Running the simulation on a CPU.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">warp_drive.utils.constants</span> <span class="kn">import</span> <span class="n">Constants</span>
        <span class="kn">from</span> <span class="nn">warp_drive.utils.data_feed</span> <span class="kn">import</span> <span class="n">DataFeed</span>

        <span class="n">_OBSERVATIONS</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">OBSERVATIONS</span>
        <span class="n">_ACTIONS</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ACTIONS</span>
        <span class="n">_REWARDS</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">REWARDS</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Warning: The &#39;WarpDrive&#39; package is not found and cannot be used! &quot;</span>
        <span class="s2">&quot;If you wish to use WarpDrive, please run &quot;</span>
        <span class="s2">&quot;&#39;pip install rl-warp-drive&#39; first.&quot;</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPUs found! Running the simulation on a CPU.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="CovidAndEconomyEnvironment"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment">[docs]</a><span class="nd">@scenario_registry</span><span class="o">.</span><span class="n">add</span>
<span class="k">class</span> <span class="nc">CovidAndEconomyEnvironment</span><span class="p">(</span><span class="n">BaseEnvironment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simulation to model health and economy dynamics amidst the COVID-19 pandemic.</span>
<span class="sd">    The environment comprising 51 agents (each agent corresponding to a US state and</span>
<span class="sd">    Washington D.C.) and the Federal Government (planner). The state agents decide the</span>
<span class="sd">    stringency level of the policy response to the pandemic, while the federal</span>
<span class="sd">    government provides subsidies to eligible individuals.</span>

<span class="sd">    This simulation makes modeling assumptions. For details, see the technical paper:</span>
<span class="sd">    https://arxiv.org/abs/2108.02904</span>

<span class="sd">    Args:</span>
<span class="sd">        use_real_world_data (bool): Replay what happened in the real world.</span>
<span class="sd">            Real-world data comprises SIR (susceptible/infected/recovered),</span>
<span class="sd">            unemployment, government policy, and vaccination numbers.</span>
<span class="sd">            This setting also sets use_real_world_policies=True.</span>
<span class="sd">        use_real_world_policies (bool): Run the environment with real-world policies</span>
<span class="sd">            (stringency levels and subsidies). With this setting and</span>
<span class="sd">            use_real_world_data=False, SIR and economy dynamics are still</span>
<span class="sd">            driven by fitted models.</span>
<span class="sd">        path_to_data_and_fitted_params (dirpath): Full path to the directory containing</span>
<span class="sd">            the data, fitted parameters and model constants. This defaults to</span>
<span class="sd">            &quot;ai_economist/datasets/covid19_datasets/data_and_fitted_params&quot;.</span>
<span class="sd">            For details on obtaining these parameters, please see the notebook</span>
<span class="sd">            &quot;ai-economist-foundation/ai_economist/datasets/covid19_datasets/</span>
<span class="sd">            gather_real_world_data_and_fit_parameters.ipynb&quot;.</span>
<span class="sd">        start_date (string): Date (YYYY-MM-DD) to start the simulation.</span>
<span class="sd">        pop_between_age_18_65 (float): Fraction of the population between ages 18-65.</span>
<span class="sd">            This is the subset of the population whose employment/unemployment affects</span>
<span class="sd">            economic productivity.</span>
<span class="sd">            Range: 0 &lt;= pop_between_age_18_65 &lt;= 1.</span>
<span class="sd">        infection_too_sick_to_work_rate (float): Fraction of people infected with</span>
<span class="sd">            COVID-19. Infected people don&#39;t work.</span>
<span class="sd">            Range: 0 &lt;= infection_too_sick_to_work_rate &lt;= 1</span>
<span class="sd">        risk_free_interest_rate (float): Percentage of interest paid by the federal</span>
<span class="sd">            government to borrow money from the federal reserve for COVID-19 relief</span>
<span class="sd">            (direct payments). Higher interest rates mean that direct payments</span>
<span class="sd">            have a larger cost on the federal government&#39;s economic index.</span>
<span class="sd">            Range: 0 &lt;= risk_free_interest_rate</span>
<span class="sd">        economic_reward_crra_eta (float): CRRA eta parameter for modeling the economic</span>
<span class="sd">            reward non-linearity.</span>
<span class="sd">            A useful reference: https://en.wikipedia.org/wiki/Isoelastic_utility</span>
<span class="sd">            Range: 0 &lt;= economic_reward_crra_eta</span>
<span class="sd">        health_priority_scaling_agents (float): A factor indicating how much more the</span>
<span class="sd">            states prioritize health (roughly speaking, loss of lives due to</span>
<span class="sd">            opening up more) over the economy (roughly speaking, a loss in GDP</span>
<span class="sd">            due to shutting down resulting in more unemployment) compared to the</span>
<span class="sd">            real-world.</span>
<span class="sd">            For example, a value of 1 corresponds to the real-world, while</span>
<span class="sd">            a value of 2 means that states cared twice as much about public health</span>
<span class="sd">            (preventing deaths), while a value of 0.5 means that states cared twice</span>
<span class="sd">            as much about the economy (preventing GDP drops).</span>
<span class="sd">            Range: 0 &lt;= health_priority_scaling_agents</span>
<span class="sd">        health_priority_scaling_planner (float): same as above,</span>
<span class="sd">            but for the federal government.</span>
<span class="sd">            Range: 0 &lt;= health_priority_scaling_planner</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">base_env_args</span><span class="p">,</span>
        <span class="n">use_real_world_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">use_real_world_policies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">path_to_data_and_fitted_params</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">start_date</span><span class="o">=</span><span class="s2">&quot;2020-03-22&quot;</span><span class="p">,</span>
        <span class="n">pop_between_age_18_65</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">infection_too_sick_to_work_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">risk_free_interest_rate</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
        <span class="n">economic_reward_crra_eta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">health_priority_scaling_agents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">health_priority_scaling_planner</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">reward_normalization_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">base_env_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">verify_activation_code</span><span class="p">()</span>

        <span class="c1"># Used for datatype checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>

        <span class="c1"># Flag to use real-world data or the fitted models instead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_data</span> <span class="o">=</span> <span class="n">use_real_world_data</span>
        <span class="c1"># Flag to use real-world policies (actions) or the supplied actions instead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_policies</span> <span class="o">=</span> <span class="n">use_real_world_policies</span>

        <span class="c1"># If we use real-world data, we also want to use the real-world policies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Using real-world data to initialize as well as to &quot;</span>
                <span class="s2">&quot;step through the env.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Note: under this setting, the real_world policies are also used.</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_policies</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Since the env. config. &#39;use_real_world_data&#39; is True, please also &quot;</span>
                <span class="s2">&quot;set &#39;use_real_world_policies&#39; to True.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Using the real-world data to only initialize the env, &quot;</span>
                <span class="s2">&quot;and using the fitted models to step through the env.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load real-world date</span>
        <span class="k">if</span> <span class="n">path_to_data_and_fitted_params</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;../../../datasets/covid19_datasets/data_and_fitted_params&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span> <span class="o">=</span> <span class="n">path_to_data_and_fitted_params</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Loading real-world data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">real_world_data_npz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span><span class="p">,</span> <span class="s2">&quot;real_world_data.npz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">real_world_data_npz</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_world_data_npz</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Load fitted parameters</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Loading fit parameters from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model_constants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_fitted_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_data_and_fitted_params</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect data format, should be </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Start date should be beyond the date for which data is available</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_start_date</span>

        <span class="c1"># Compute a start date index based on policy start date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">])</span>

        <span class="c1"># For date logging (This will be overwritten in additional_reset_steps;</span>
        <span class="c1"># see below)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># When using real-world policy, limit the episode length</span>
        <span class="c1"># to the length of the available policy.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_policies</span><span class="p">:</span>
            <span class="n">real_world_policy_length</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using real-world policies, ignoring external action inputs.&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_env_kwargs</span><span class="p">[</span><span class="s2">&quot;episode_length&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">real_world_policy_length</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The real-world policies are only available for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">real_world_policy_length</span><span class="si">}</span><span class="s2"> timesteps; so the &#39;episode_length&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;in the environment configuration can only be at most &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">real_world_policy_length</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using external action inputs.&quot;</span><span class="p">)</span>

        <span class="c1"># US states and populations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">base_env_kwargs</span><span class="p">[</span><span class="s2">&quot;n_agents&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span>
        <span class="p">),</span> <span class="s2">&quot;n_agents should be set to the number of US states, i.e., </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span>
        <span class="p">)</span>
        <span class="c1"># Note: For a faster environment step time, we collate all the individual agents</span>
        <span class="c1"># into a single agent index &quot;a&quot; and we flatten the component action masks too.</span>
        <span class="k">assert</span> <span class="n">base_env_kwargs</span><span class="p">[</span>
            <span class="s2">&quot;collate_agent_step_and_reset_data&quot;</span>
        <span class="p">],</span> <span class="s2">&quot;The env. config &#39;collate_agent_step_and_reset_data&#39; should be set to True.&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">base_env_args</span><span class="p">,</span> <span class="o">**</span><span class="n">base_env_kwargs</span><span class="p">)</span>

        <span class="c1"># Add attributes to self.world for use in components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">us_state_population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">us_population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_population</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">n_stringency_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stringency_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">use_real_world_policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_policies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_policies</span><span class="p">:</span>
            <span class="c1"># Agent open/close stringency levels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">real_world_stringency_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="p">:</span>
            <span class="p">]</span>
            <span class="c1"># Planner subsidy levels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">real_world_subsidy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;subsidy&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="p">:</span>
            <span class="p">]</span>

        <span class="c1"># Policy --&gt; Unemployment</span>
        <span class="c1">#   For accurately modeling the state-wise unemployment, we convolve</span>
        <span class="c1">#   the current stringency policy with a family of exponential filters</span>
        <span class="c1">#   with separate means (lambdas).</span>
        <span class="c1"># This code sets up things we will use in `unemployment_step()`,</span>
        <span class="c1">#   which includes a detailed breakdown of how the unemployment model is</span>
        <span class="c1">#   implemented.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Each filter captures a temporally extended response to a stringency change.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unemp_conv_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f_ts</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_lambdas</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="c1"># Each state weights these filters differently.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeated_conv_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grouped_convolutional_filter_weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
            <span class="p">)[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># For manually modulating SIR/Unemployment parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_beta_intercepts_modulation</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_beta_slopes_modulation</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unemployment_modulation</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Economy-related</span>
        <span class="c1"># Interest rate for borrowing money from the federal reserve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_free_interest_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span><span class="n">risk_free_interest_rate</span><span class="p">)</span>

        <span class="c1"># Compute each worker&#39;s daily productivity when at work (to match 2019 GDP)</span>
        <span class="c1"># We assume the open/close stringency policy level was always at it&#39;s lowest</span>
        <span class="c1"># value (i.e., 1) before the pandemic started.</span>
        <span class="n">num_unemployed_at_stringency_level_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unemployment_step</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">workforce</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">us_population</span> <span class="o">*</span> <span class="n">pop_between_age_18_65</span>
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num_unemployed_at_stringency_level_1</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="n">workers_per_capita</span> <span class="o">=</span> <span class="p">(</span><span class="n">workforce</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_population</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="n">gdp_per_worker</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gdp_per_capita</span> <span class="o">/</span> <span class="n">workers_per_capita</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span> <span class="o">=</span> <span class="mi">365</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_production_per_worker</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">gdp_per_worker</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">infection_too_sick_to_work_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">infection_too_sick_to_work_rate</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infection_too_sick_to_work_rate</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pop_between_age_18_65</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span><span class="n">pop_between_age_18_65</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_between_age_18_65</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="c1"># Compute max possible productivity values (used for agent reward normalization)</span>
        <span class="n">max_productivity_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">economy_step</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
            <span class="n">num_unemployed_at_stringency_level_1</span><span class="p">,</span>
            <span class="n">infection_too_sick_to_work_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infection_too_sick_to_work_rate</span><span class="p">,</span>
            <span class="n">population_between_age_18_65</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_between_age_18_65</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_productivity_t</span> <span class="o">=</span> <span class="n">max_productivity_t</span>

        <span class="c1"># Economic reward non-linearity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">economic_reward_crra_eta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span><span class="n">economic_reward_crra_eta</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">economic_reward_crra_eta</span> <span class="o">&lt;</span> <span class="mf">20.0</span>

        <span class="c1"># Health indices are normalized by maximum annual GDP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_health_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_productivity_t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planner_health_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents_health_norm</span><span class="p">)</span>

        <span class="c1"># Economic indices are normalized by maximum annual GDP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_economic_norm</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maximum_productivity_t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planner_economic_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents_economic_norm</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">scale_health_over_economic_index</span><span class="p">(</span><span class="n">health_priority_scaling</span><span class="p">,</span> <span class="n">alphas</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Given starting alpha(s), compute new alphas so that the</span>
<span class="sd">            resulting alpha:1-alpha ratio is scaled by health_weightage</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">alphas</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alphas</span><span class="p">)</span>  <span class="c1"># alphas = z / (1 + z)</span>
            <span class="n">scaled_z</span> <span class="o">=</span> <span class="n">health_priority_scaling</span> <span class="o">*</span> <span class="n">z</span>
            <span class="n">new_alphas</span> <span class="o">=</span> <span class="n">scaled_z</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">scaled_z</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_alphas</span>

        <span class="c1"># Agents&#39; health and economic index weightages</span>
        <span class="c1"># fmt: off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_health_index</span> <span class="o">=</span> \
            <span class="n">scale_health_over_economic_index</span><span class="p">(</span>
                <span class="n">health_priority_scaling_agents</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inferred_weightage_on_agent_health_index</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># fmt: on</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_health_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_health_index</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_economic_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_health_index</span>
        <span class="p">)</span>

        <span class="c1"># Planner&#39;s health and economic index weightages</span>
        <span class="c1"># fmt: off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_health_index</span> <span class="o">=</span> \
            <span class="n">scale_health_over_economic_index</span><span class="p">(</span>
                <span class="n">health_priority_scaling_planner</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inferred_weightage_on_planner_health_index</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># fmt: on</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_health_index</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_economic_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_health_index</span>
        <span class="p">)</span>

        <span class="c1"># Normalization factor for the reward (often useful for RL training)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_normalization_factor</span> <span class="o">=</span> <span class="n">reward_normalization_factor</span>

        <span class="c1"># CUDA-related attributes (for GPU simulations)</span>
        <span class="c1"># Note: these will be set / overwritten via the env_wrapper</span>
        <span class="c1"># use_cuda will be set to True (by the env_wrapper), if needed</span>
        <span class="c1"># to be simulated on the GPU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_function_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_step</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_compute_reward</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>

        <span class="c1"># Adding use_cuda to self.world for use in components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">use_cuda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">cuda_data_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">cuda_function_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_function_manager</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;CovidAndEconomySimulation&quot;</span>
    <span class="n">agent_subclasses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BasicMobileAgent&quot;</span><span class="p">,</span> <span class="s2">&quot;BasicPlanner&quot;</span><span class="p">]</span>

    <span class="n">required_entities</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.reset_starting_layout"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.reset_starting_layout">[docs]</a>    <span class="k">def</span> <span class="nf">reset_starting_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.reset_agent_states"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.reset_agent_states">[docs]</a>    <span class="k">def</span> <span class="nf">reset_agent_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">clear_agent_locs</span><span class="p">()</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.get_data_dictionary"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.get_data_dictionary">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of data to push to the GPU (device).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">DataFeed</span><span class="p">()</span>
        <span class="c1"># Global States</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;susceptible&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Susceptible&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infected&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Infected&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;recovered&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Recovered&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;deaths&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Deaths&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unemployed&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Unemployed&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vaccinated&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Vaccinated&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Actions</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;stringency_level&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Stringency Level&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subsidy_level&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Subsidy Level&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Economy-related</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subsidy&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Subsidy&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;postsubsidy_productivity&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">],</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;productivity&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Susceptible&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
            <span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;incapacitated&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cant_work&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;num_people_that_can_work&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;us_state_population&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infection_too_sick_to_work_rate&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infection_too_sick_to_work_rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;population_between_age_18_65&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_between_age_18_65</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;daily_production_per_worker&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_production_per_worker</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;maximum_productivity&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_productivity_t</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># SIR-related</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;real_world_stringency_policy_history&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">][</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">,</span>
                    <span class="p">:,</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta_delay&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta_slopes&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_slopes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta_intercepts&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_intercepts</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;death_rate&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">death_rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Unemployment fit parameters</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;filter_len&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;num_filters&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delta_stringency_level&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grouped_convolutional_filter_weights&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grouped_convolutional_filter_weights</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unemp_conv_filters&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unemp_conv_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unemployment_bias&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unemployment_bias</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">save_copy_and_apply_at_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Reward-related</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;min_marginal_agent_health_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_agent_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;max_marginal_agent_health_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_agent_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;min_marginal_agent_economic_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_agent_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;max_marginal_agent_economic_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_agent_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;min_marginal_planner_health_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_planner_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;max_marginal_planner_health_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_planner_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;min_marginal_planner_economic_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_planner_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;max_marginal_planner_economic_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_planner_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weightage_on_marginal_agent_health_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weightage_on_marginal_agent_economic_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weightage_on_marginal_planner_health_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weightage_on_marginal_planner_economic_index&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;value_of_life&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value_of_life</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;economic_reward_crra_eta&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">economic_reward_crra_eta</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;num_days_in_an_year&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;risk_free_interest_rate&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_free_interest_rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;agents_health_norm&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents_health_norm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;agents_economic_norm&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents_economic_norm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;planner_health_norm&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planner_health_norm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data_dict</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;planner_economic_norm&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planner_economic_norm</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">data_dict</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.get_tensor_dictionary"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.get_tensor_dictionary">[docs]</a>    <span class="k">def</span> <span class="nf">get_tensor_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of (Pytorch-accessible) data to push to the GPU (device).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor_dict</span> <span class="o">=</span> <span class="n">DataFeed</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tensor_dict</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.scenario_step"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.scenario_step">[docs]</a>    <span class="k">def</span> <span class="nf">scenario_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the state of the USA based on the Covid-19 and Economy dynamics.</span>
<span class="sd">        This internally implements three steps</span>
<span class="sd">        - sir_step() - updates the susceptible, infected, recovered, deaths</span>
<span class="sd">        and vaccination numbers based on the SIR equations</span>
<span class="sd">        - unemployment_step() - uses the unemployment model to updates the unemployment</span>
<span class="sd">         based on the stringency levels</span>
<span class="sd">        - economy_step - computes the current producitivity numbers for the agents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cuda_step</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;susceptible&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;infected&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;recovered&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;deaths&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;vaccinated&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;unemployed&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;subsidy&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;productivity&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;stringency_level&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;num_stringency_levels&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;postsubsidy_productivity&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;num_vaccines_available_t&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;real_world_stringency_policy_history&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;beta_delay&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;beta_slopes&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;beta_intercepts&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;death_rate&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;incapacitated&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;cant_work&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;num_people_that_can_work&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;us_state_population&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;infection_too_sick_to_work_rate&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;population_between_age_18_65&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;filter_len&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;num_filters&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;delta_stringency_level&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;grouped_convolutional_filter_weights&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;unemp_conv_filters&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;unemployment_bias&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;signal&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;daily_production_per_worker&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;maximum_productivity&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_a_world-agent_state&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_a_world-agent_postsubsidy_productivity&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_a_world-lagged_stringency_level&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_a_time&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_p_world-agent_state&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_p_world-agent_postsubsidy_productivity&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_p_world-lagged_stringency_level&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_OBSERVATIONS</span><span class="si">}</span><span class="s2">_p_time&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;_timestep_&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">meta_info</span><span class="p">(</span><span class="s2">&quot;n_agents&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">meta_info</span><span class="p">(</span><span class="s2">&quot;episode_length&quot;</span><span class="p">),</span>
                <span class="n">block</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">cuda_function_manager</span><span class="o">.</span><span class="n">block</span><span class="p">,</span>
                <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">cuda_function_manager</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">curr_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># SIR</span>
            <span class="c1"># ---</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_data</span><span class="p">:</span>
                <span class="n">_S_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;susceptible&quot;</span><span class="p">][</span>
                        <span class="n">curr_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span>
                    <span class="p">],</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_I_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;infected&quot;</span><span class="p">][</span><span class="n">curr_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">],</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_R_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;recovered&quot;</span><span class="p">][</span><span class="n">curr_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">],</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_V_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;vaccinated&quot;</span><span class="p">][</span><span class="n">curr_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">],</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_D_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;deaths&quot;</span><span class="p">][</span><span class="n">curr_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">],</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Use simulation logic</span>
                <span class="k">if</span> <span class="n">curr_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">+</span> <span class="n">curr_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">stringency_level_tmk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stringency_level_tmk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">+</span> <span class="n">curr_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span><span class="p">,</span> <span class="p">:</span>
                        <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stringency_level_tmk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Stringency Level&quot;</span><span class="p">][</span>
                        <span class="n">curr_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span>
                    <span class="p">]</span>
                <span class="n">stringency_level_tmk</span> <span class="o">=</span> <span class="n">stringency_level_tmk</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>

                <span class="n">_S_tm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Susceptible&quot;</span><span class="p">][</span><span class="n">prev_t</span><span class="p">]</span>
                <span class="n">_I_tm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Infected&quot;</span><span class="p">][</span><span class="n">prev_t</span><span class="p">]</span>
                <span class="n">_R_tm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Recovered&quot;</span><span class="p">][</span><span class="n">prev_t</span><span class="p">]</span>
                <span class="n">_V_tm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Vaccinated&quot;</span><span class="p">][</span><span class="n">prev_t</span><span class="p">]</span>

                <span class="c1"># Vaccination</span>
                <span class="c1"># -----------</span>
                <span class="n">num_vaccines_available_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">aidx</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
                    <span class="c1"># &quot;Load&quot; the vaccines in the inventory into this vector.</span>
                    <span class="n">num_vaccines_available_t</span><span class="p">[</span><span class="n">aidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Vaccines Available&quot;</span><span class="p">]</span>
                    <span class="c1"># Agents always use whatever vaccines they can, so this becomes 0:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Vaccinated&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Vaccines Available&quot;</span><span class="p">]</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Vaccines Available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># SIR step</span>
                <span class="c1"># --------</span>
                <span class="n">_dS</span><span class="p">,</span> <span class="n">_dI</span><span class="p">,</span> <span class="n">_dR</span><span class="p">,</span> <span class="n">_dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sir_step</span><span class="p">(</span>
                    <span class="n">_S_tm1</span><span class="p">,</span>
                    <span class="n">_I_tm1</span><span class="p">,</span>
                    <span class="n">stringency_level_tmk</span><span class="p">,</span>
                    <span class="n">num_vaccines_available_t</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">_S_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">_S_tm1</span> <span class="o">+</span> <span class="n">_dS</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">_I_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">_I_tm1</span> <span class="o">+</span> <span class="n">_dI</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">_R_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">_R_tm1</span> <span class="o">+</span> <span class="n">_dR</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">_V_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">_V_tm1</span> <span class="o">+</span> <span class="n">_dV</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">num_recovered_but_not_vaccinated_t</span> <span class="o">=</span> <span class="n">_R_t</span> <span class="o">-</span> <span class="n">_V_t</span>
                <span class="n">_D_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_rate</span> <span class="o">*</span> <span class="n">num_recovered_but_not_vaccinated_t</span>

            <span class="c1"># Update global state</span>
            <span class="c1"># -------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Susceptible&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_S_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Infected&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_I_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Recovered&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_R_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Deaths&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_D_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Vaccinated&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_V_t</span>

            <span class="c1"># Unemployment</span>
            <span class="c1"># ------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real_world_data</span><span class="p">:</span>
                <span class="n">num_unemployed_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;unemployed&quot;</span><span class="p">][</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">+</span> <span class="n">curr_t</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_unemployed_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unemployment_step</span><span class="p">(</span>
                    <span class="n">current_stringency_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span>
                        <span class="s2">&quot;Stringency Level&quot;</span>
                    <span class="p">][</span><span class="n">curr_t</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Unemployed&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_unemployed_t</span>

            <span class="c1"># Productivity</span>
            <span class="c1"># ------------</span>
            <span class="n">productivity_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">economy_step</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">,</span>
                <span class="n">infected</span><span class="o">=</span><span class="n">_I_t</span><span class="p">,</span>
                <span class="n">deaths</span><span class="o">=</span><span class="n">_D_t</span><span class="p">,</span>
                <span class="n">unemployed</span><span class="o">=</span><span class="n">num_unemployed_t</span><span class="p">,</span>
                <span class="n">infection_too_sick_to_work_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infection_too_sick_to_work_rate</span><span class="p">,</span>
                <span class="n">population_between_age_18_65</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_between_age_18_65</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Subsidies</span>
            <span class="c1"># ---------</span>
            <span class="c1"># Add federal government subsidy to productivity</span>
            <span class="n">daily_statewise_subsidy_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Subsidy&quot;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span>
            <span class="n">postsubsidy_productivity_t</span> <span class="o">=</span> <span class="n">productivity_t</span> <span class="o">+</span> <span class="n">daily_statewise_subsidy_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">][</span>
                <span class="n">curr_t</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">postsubsidy_productivity_t</span>

            <span class="c1"># Update agent state</span>
            <span class="c1"># ------------------</span>
            <span class="n">current_date_string</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_date</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_format</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Susceptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_S_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
                <span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Infections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">_I_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_I_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
                <span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Recovered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_R_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
                <span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_D_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span>
                    <span class="s2">&quot;Total Deaths&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_D_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Vaccinated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_V_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
                <span class="p">)</span>

                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Unemployed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_unemployed_t</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
                <span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Subsidy Received&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_statewise_subsidy_t</span><span class="p">[</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">idx</span>
                <span class="p">]</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">postsubsidy_productivity_t</span><span class="p">[</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">idx</span>
                <span class="p">]</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_date_string</span>

            <span class="c1"># Update planner state</span>
            <span class="c1"># --------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Susceptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_S_t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Infections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_I_t</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_I_t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Recovered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_R_t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_D_t</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_D_t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Vaccinated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_V_t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Unemployed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">num_unemployed_t</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Subsidy Provided&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">daily_statewise_subsidy_t</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">postsubsidy_productivity_t</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_date_string</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.generate_observations"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.generate_observations">[docs]</a>    <span class="k">def</span> <span class="nf">generate_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Process agent-specific and planner-specific data into an observation.</span>
<span class="sd">        - Observations contain only the relevant features for that actor.</span>
<span class="sd">        :return: a dictionary of observations for each agent and planner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redux_agent_global_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;Susceptible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Infected&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Recovered&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Deaths&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Vaccinated&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unemployed&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">redux_agent_global_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">redux_agent_global_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">redux_agent_global_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">redux_agent_global_state</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">normalized_redux_agent_state</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">redux_agent_global_state</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Productivity</span>
        <span class="n">postsubsidy_productivity_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span>
            <span class="s2">&quot;Postsubsidy Productivity&quot;</span>
        <span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">]</span>
        <span class="n">normalized_postsubsidy_productivity_t</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">postsubsidy_productivity_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_productivity_t</span>
        <span class="p">)</span>

        <span class="c1"># Let agents know about the policy about to affect SIR infection-rate beta</span>
        <span class="n">t_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">t_beta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lagged_stringency_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">+</span> <span class="n">t_beta</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lagged_stringency_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Stringency Level&quot;</span><span class="p">][</span>
                <span class="n">t_beta</span>
            <span class="p">]</span>

        <span class="n">normalized_lagged_stringency_level</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lagged_stringency_level</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_stringency_levels</span>
        <span class="p">)</span>

        <span class="c1"># To condition policy on agent id</span>
        <span class="n">agent_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>

        <span class="c1"># Observation dict - Agents</span>
        <span class="c1"># -------------------------</span>
        <span class="n">obs_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">obs_dict</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;agent_index&quot;</span><span class="p">:</span> <span class="n">agent_index</span><span class="p">,</span>
            <span class="s2">&quot;agent_state&quot;</span><span class="p">:</span> <span class="n">normalized_redux_agent_state</span><span class="p">,</span>
            <span class="s2">&quot;agent_postsubsidy_productivity&quot;</span><span class="p">:</span> <span class="n">normalized_postsubsidy_productivity_t</span><span class="p">,</span>
            <span class="s2">&quot;lagged_stringency_level&quot;</span><span class="p">:</span> <span class="n">normalized_lagged_stringency_level</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Observation dict - Planner</span>
        <span class="c1"># --------------------------</span>
        <span class="n">obs_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;agent_state&quot;</span><span class="p">:</span> <span class="n">normalized_redux_agent_state</span><span class="p">,</span>
            <span class="s2">&quot;agent_postsubsidy_productivity&quot;</span><span class="p">:</span> <span class="n">normalized_postsubsidy_productivity_t</span><span class="p">,</span>
            <span class="s2">&quot;lagged_stringency_level&quot;</span><span class="p">:</span> <span class="n">normalized_lagged_stringency_level</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">obs_dict</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.compute_reward"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.compute_reward">[docs]</a>    <span class="k">def</span> <span class="nf">compute_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the social welfare metrics for each agent and the planner.</span>
<span class="sd">        :return: a dictionary of rewards for each agent in the simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cuda_compute_reward</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_REWARDS</span><span class="si">}</span><span class="s2">_a&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_REWARDS</span><span class="si">}</span><span class="s2">_p&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;num_days_in_an_year&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;value_of_life&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;risk_free_interest_rate&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;economic_reward_crra_eta&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;min_marginal_agent_health_index&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;max_marginal_agent_health_index&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;min_marginal_agent_economic_index&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;max_marginal_agent_economic_index&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;min_marginal_planner_health_index&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;max_marginal_planner_health_index&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;min_marginal_planner_economic_index&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;max_marginal_planner_economic_index&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;weightage_on_marginal_agent_health_index&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;weightage_on_marginal_agent_economic_index&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;weightage_on_marginal_planner_health_index&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span>
                    <span class="s2">&quot;weightage_on_marginal_planner_economic_index&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;agents_health_norm&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;agents_economic_norm&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;planner_health_norm&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;planner_economic_norm&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;deaths&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;subsidy&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;postsubsidy_productivity&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;_done_&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">device_data</span><span class="p">(</span><span class="s2">&quot;_timestep_&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">meta_info</span><span class="p">(</span><span class="s2">&quot;n_agents&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cuda_data_manager</span><span class="o">.</span><span class="n">meta_info</span><span class="p">(</span><span class="s2">&quot;episode_length&quot;</span><span class="p">),</span>
                <span class="n">block</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">cuda_function_manager</span><span class="o">.</span><span class="n">block</span><span class="p">,</span>
                <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">cuda_function_manager</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>  <span class="c1"># Return empty dict. Reward arrays are updated in-place</span>
        <span class="n">rew</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">crra_nonlinearity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
            <span class="c1"># Reference: https://en.wikipedia.org/wiki/Isoelastic_utility</span>
            <span class="c1"># To be applied to (marginal) economic indices</span>
            <span class="n">annual_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span> <span class="o">*</span> <span class="n">x</span>
            <span class="n">annual_x_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">annual_x</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">annual_crra</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">annual_x_clipped</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span>
            <span class="n">daily_crra</span> <span class="o">=</span> <span class="n">annual_crra</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_days_in_an_year</span>
            <span class="k">return</span> <span class="n">daily_crra</span>

        <span class="k">def</span> <span class="nf">min_max_normalization</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">):</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-10</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_weighted_average</span><span class="p">(</span>
            <span class="n">health_index_weightage</span><span class="p">,</span>
            <span class="n">health_index</span><span class="p">,</span>
            <span class="n">economic_index_weightage</span><span class="p">,</span>
            <span class="n">economic_index</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">health_index_weightage</span> <span class="o">*</span> <span class="n">health_index</span>
                <span class="o">+</span> <span class="n">economic_index_weightage</span> <span class="o">*</span> <span class="n">economic_index</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">health_index_weightage</span> <span class="o">+</span> <span class="n">economic_index_weightage</span><span class="p">)</span>

        <span class="c1"># Changes this last timestep:</span>
        <span class="n">marginal_deaths</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Deaths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">]</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Deaths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">subsidy_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Subsidy&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">]</span>
        <span class="n">postsubsidy_productivity_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span>
            <span class="s2">&quot;Postsubsidy Productivity&quot;</span>
        <span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">]</span>

        <span class="c1"># Health index -- the cost equivalent (annual GDP) of covid deaths</span>
        <span class="c1"># Note: casting deaths to float to prevent overflow issues</span>
        <span class="n">marginal_agent_health_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">marginal_deaths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_of_life</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_health_norm</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="c1"># Economic index -- fraction of annual GDP achieved</span>
        <span class="c1"># Use a &quot;crra&quot; nonlinearity on the agent economic reward</span>
        <span class="n">marginal_agent_economic_index</span> <span class="o">=</span> <span class="n">crra_nonlinearity</span><span class="p">(</span>
            <span class="n">postsubsidy_productivity_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_economic_norm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">economic_reward_crra_eta</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="c1"># Min-max Normalization</span>
        <span class="n">marginal_agent_health_index</span> <span class="o">=</span> <span class="n">min_max_normalization</span><span class="p">(</span>
            <span class="n">marginal_agent_health_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_agent_health_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_agent_health_index</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
        <span class="n">marginal_agent_economic_index</span> <span class="o">=</span> <span class="n">min_max_normalization</span><span class="p">(</span>
            <span class="n">marginal_agent_economic_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_agent_economic_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_agent_economic_index</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="c1"># Agent Rewards</span>
        <span class="c1"># -------------</span>
        <span class="n">agent_rewards</span> <span class="o">=</span> <span class="n">get_weighted_average</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_health_index</span><span class="p">,</span>
            <span class="n">marginal_agent_health_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_agent_economic_index</span><span class="p">,</span>
            <span class="n">marginal_agent_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rew</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_rewards</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_normalization_factor</span>

        <span class="c1"># Update agent states</span>
        <span class="c1"># -------------------</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Health Index&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">marginal_agent_health_index</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Economic Index&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">marginal_agent_economic_index</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># National level</span>
        <span class="c1"># --------------</span>
        <span class="c1"># Health index -- the cost equivalent (annual GDP) of covid deaths</span>
        <span class="c1"># Note: casting deaths to float to prevent overflow issues</span>
        <span class="n">marginal_planner_health_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">marginal_deaths</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_of_life</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">planner_health_norm</span>
        <span class="p">)</span>

        <span class="c1"># Economic index -- fraction of annual GDP achieved (minus subsidy cost)</span>
        <span class="n">cost_of_subsidy_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_free_interest_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subsidy_t</span><span class="p">)</span>
        <span class="c1"># Use a &quot;crra&quot; nonlinearity on the planner economic reward</span>
        <span class="n">marginal_planner_economic_index</span> <span class="o">=</span> <span class="n">crra_nonlinearity</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">postsubsidy_productivity_t</span><span class="p">)</span> <span class="o">-</span> <span class="n">cost_of_subsidy_t</span><span class="p">)</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">planner_economic_norm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">economic_reward_crra_eta</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Min-max Normalization</span>
        <span class="n">marginal_planner_health_index</span> <span class="o">=</span> <span class="n">min_max_normalization</span><span class="p">(</span>
            <span class="n">marginal_planner_health_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_planner_health_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_planner_health_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">marginal_planner_economic_index</span> <span class="o">=</span> <span class="n">min_max_normalization</span><span class="p">(</span>
            <span class="n">marginal_planner_economic_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_planner_economic_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_planner_economic_index</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update planner states</span>
        <span class="c1"># -------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Health Index&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">marginal_planner_health_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Economic Index&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">marginal_planner_economic_index</span>

        <span class="c1"># Planner Reward</span>
        <span class="c1"># --------------</span>
        <span class="n">planner_rewards</span> <span class="o">=</span> <span class="n">get_weighted_average</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_health_index</span><span class="p">,</span>
            <span class="n">marginal_planner_health_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weightage_on_marginal_planner_economic_index</span><span class="p">,</span>
            <span class="n">marginal_planner_economic_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">planner_rewards</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_normalization_factor</span>

        <span class="k">return</span> <span class="n">rew</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.additional_reset_steps"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.additional_reset_steps">[docs]</a>    <span class="k">def</span> <span class="nf">additional_reset_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Reset current date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>

        <span class="c1"># SIR numbers at timestep 0</span>
        <span class="n">susceptible_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;susceptible&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">]</span>
        <span class="n">infected_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;infected&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">]</span>
        <span class="n">newly_infected_0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">infected_0</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;infected&quot;</span><span class="p">][</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">recovered_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;recovered&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">]</span>
        <span class="n">deaths_0</span> <span class="o">=</span> <span class="n">recovered_0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_rate</span>

        <span class="c1"># Unemployment and vaccinated numbers at timestep 0</span>
        <span class="n">unemployed_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;unemployed&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">]</span>
        <span class="n">vaccinated_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;vaccinated&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">]</span>

        <span class="c1"># Create a global state dictionary to save episode data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Susceptible&quot;</span><span class="p">,</span> <span class="n">susceptible_0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Infected&quot;</span><span class="p">,</span> <span class="n">infected_0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Recovered&quot;</span><span class="p">,</span> <span class="n">recovered_0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Deaths&quot;</span><span class="p">,</span> <span class="n">deaths_0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Unemployed&quot;</span><span class="p">,</span> <span class="n">unemployed_0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Vaccinated&quot;</span><span class="p">,</span> <span class="n">vaccinated_0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

        <span class="n">new_deaths_0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">deaths_0</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;recovered&quot;</span><span class="p">][</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_rate</span>
        <span class="p">)</span>

        <span class="c1"># Reset stringency level history.</span>
        <span class="c1"># Pad with stringency levels of 1 corresponding to states being fully open</span>
        <span class="c1"># (as was the case before the pandemic).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
            <span class="n">constant_values</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)[</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]</span>

        <span class="c1"># Set the stringency level based to the real-world policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span>
            <span class="s2">&quot;Stringency Level&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_real_world_data</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_index</span><span class="p">],</span>
            <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># All US states start with zero subsidy and zero Postsubsidy Productivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Subsidy Level&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Subsidy&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_state</span><span class="p">(</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="c1"># Set initial agent states</span>
        <span class="c1"># ------------------------</span>
        <span class="n">current_date_string</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_date</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_format</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Susceptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">susceptible_0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Infections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newly_infected_0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">infected_0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Recovered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovered_0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_deaths_0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
            <span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deaths_0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Health Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Economic Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_date_string</span>

        <span class="c1"># Planner state fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Susceptible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Susceptible&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Infections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Infections&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Infected&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Recovered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Recovered&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;New Deaths&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Deaths&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total Vaccinated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vaccinated_0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Health Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Economic Index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_date_string</span>

        <span class="c1"># Reset any manually set parameter modulations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_beta_intercepts_modulation</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_beta_slopes_modulation</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unemployment_modulation</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.set_global_state"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.set_global_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_global_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use floats by default for the SIR dynamics</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;Susceptible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Infected&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Recovered&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Deaths&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unemployed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Vaccinated&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Stringency Level&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Subsidy Level&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Subsidy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># If no values are passed, set everything to zeros.</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.set_parameter_modulations"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.set_parameter_modulations">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter_modulations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">beta_intercept</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta_slope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unemployment</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply parameter modulation, which will be in effect until the next env reset.</span>

<span class="sd">        Each modulation term scales the associated set of model parameters by the</span>
<span class="sd">        input value. This method is useful for performing a sensitivity analysis.</span>

<span class="sd">        In effect, the transmission rate (beta) will be calculated as:</span>
<span class="sd">            beta = (m_s * beta_slope)*lagged_stringency + (m_i * beta_intercept)</span>

<span class="sd">        The unemployment rate (u) will be calculated as:</span>
<span class="sd">            u = SOFTPLUS( m_u * SUM(u_filter_weight * u_filter_response) ) + u_0</span>

<span class="sd">        Args:</span>
<span class="sd">             beta_intercept: (float, &gt;= 0) Modulation applied to the intercept term</span>
<span class="sd">             of the beta model, m_i in above equations</span>
<span class="sd">             beta_slope: (float, &gt;= 0) Modulation applied to the slope term of the</span>
<span class="sd">             beta model, m_s in above equations</span>
<span class="sd">             unemployment: (float, &gt;= 0) Modulation applied to the weighted sum of</span>
<span class="sd">             unemployment filter responses, m_u in above equations.</span>

<span class="sd">        Example:</span>
<span class="sd">            # Reset the environment</span>
<span class="sd">            env.reset()</span>

<span class="sd">            # Increase the slope of the beta response by 15%</span>
<span class="sd">            env.set_parameter_modulations(beta_slope=1.15)</span>

<span class="sd">            # Run the environment (this example skips over action selection for brevity)</span>
<span class="sd">            for t in range(env.episode_length):</span>
<span class="sd">                env.step(actions[t])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_intercept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_intercept</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">beta_intercept</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">beta_intercept</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_beta_intercepts_modulation</span> <span class="o">=</span> <span class="n">beta_intercept</span>

        <span class="k">if</span> <span class="n">beta_slope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_slope</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">beta_slope</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">beta_slope</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_beta_slopes_modulation</span> <span class="o">=</span> <span class="n">beta_slope</span>

        <span class="k">if</span> <span class="n">unemployment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unemployment</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">unemployment</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">unemployment</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unemployment_modulation</span> <span class="o">=</span> <span class="n">unemployment</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.unemployment_step"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.unemployment_step">[docs]</a>    <span class="k">def</span> <span class="nf">unemployment_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_stringency_level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes unemployment given the current stringency level and past levels.</span>

<span class="sd">        Unemployment is computed as follows:</span>
<span class="sd">        1) For each of self.num_filters, an exponentially decaying filter is</span>
<span class="sd">        convolved with the history of stringency changes. Responses move forward in</span>
<span class="sd">        time, so a stringency change at time t-1 impacts the response at time t.</span>
<span class="sd">        2) The filter responses at time t (the current timestep) are summed together</span>
<span class="sd">        using state-specific weights.</span>
<span class="sd">        3) The weighted sum is passed through a SOFTPLUS function to capture excess</span>
<span class="sd">        unemployment due to stringency policy.</span>
<span class="sd">        4) The excess unemployment is added to a state-specific baseline unemployment</span>
<span class="sd">        level to get the total unemployment.</span>

<span class="sd">        Note: Internally, unemployment is computed somewhat differently for speed.</span>
<span class="sd">            In particular, no convolution is used. Instead the &quot;filter response&quot; at</span>
<span class="sd">            time t is just a temporally discounted sum of past stringency changes,</span>
<span class="sd">            with the discounting given by the filter decay rate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">softplus</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Numpy implementation of softplus. For reference, see</span>
<span class="sd">            https://pytorch.org/docs/stable/generated/torch.nn.Softplus.html</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">beta</span> <span class="o">*</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>  <span class="c1"># computing unemployment at closure policy &quot;all ones&quot;</span>
            <span class="n">delta_stringency_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                    <span class="n">current_stringency_level</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">delta_stringency_level</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringency_level_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Rather than modulating the unemployment params,</span>
        <span class="c1"># modulate the deltas (same effect)</span>
        <span class="n">delta_stringency_level</span> <span class="o">=</span> <span class="n">delta_stringency_level</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unemployment_modulation</span>

        <span class="c1"># Expand the [time, state] delta history to have a dimension for filter channel</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="n">delta_stringency_level</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Apply the state-specific filter weights to each channel</span>
        <span class="n">weighted_x_data</span> <span class="o">=</span> <span class="n">x_data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeated_conv_weights</span>

        <span class="c1"># Compute the discounted sum of the weighted deltas, with each channel using</span>
        <span class="c1"># a discounting rate reflecting the time constant of the filter channel. Also</span>
        <span class="c1"># sum over channels and use a softplus to get excess unemployment.</span>
        <span class="n">excess_unemployment</span> <span class="o">=</span> <span class="n">softplus</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_x_data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unemp_conv_filters</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Add excess unemployment to baseline unemployment</span>
        <span class="n">unemployment_rate</span> <span class="o">=</span> <span class="n">excess_unemployment</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unemployment_bias</span>

        <span class="c1"># Convert the rate (which is a percent) to raw numbers for output</span>
        <span class="n">num_unemployed_t</span> <span class="o">=</span> <span class="n">unemployment_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">num_unemployed_t</span></div>

    <span class="c1"># --- Scenario-specific ---</span>
<div class="viewcode-block" id="CovidAndEconomyEnvironment.economy_step"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.economy_step">[docs]</a>    <span class="k">def</span> <span class="nf">economy_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">population</span><span class="p">,</span>
        <span class="n">infected</span><span class="p">,</span>
        <span class="n">deaths</span><span class="p">,</span>
        <span class="n">unemployed</span><span class="p">,</span>
        <span class="n">infection_too_sick_to_work_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">population_between_age_18_65</span><span class="o">=</span><span class="mf">0.67</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes how much production occurs.</span>

<span class="sd">        Assumptions:</span>

<span class="sd">        - People that cannot work: &quot;infected + aware&quot; and &quot;unemployed&quot; and &quot;deaths&quot;.</span>
<span class="sd">        - No life/death cycles.</span>

<span class="sd">        See __init__() for pre-computation of each worker&#39;s daily productivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">incapacitated</span> <span class="o">=</span> <span class="p">(</span><span class="n">infection_too_sick_to_work_rate</span> <span class="o">*</span> <span class="n">infected</span><span class="p">)</span> <span class="o">+</span> <span class="n">deaths</span>
        <span class="n">cant_work</span> <span class="o">=</span> <span class="p">(</span><span class="n">incapacitated</span> <span class="o">*</span> <span class="n">population_between_age_18_65</span><span class="p">)</span> <span class="o">+</span> <span class="n">unemployed</span>

        <span class="n">num_workers</span> <span class="o">=</span> <span class="n">population</span> <span class="o">*</span> <span class="n">population_between_age_18_65</span>

        <span class="n">num_people_that_can_work</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_workers</span> <span class="o">-</span> <span class="n">cant_work</span><span class="p">)</span>

        <span class="n">productivity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">num_people_that_can_work</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_production_per_worker</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">productivity</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.sir_step"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.sir_step">[docs]</a>    <span class="k">def</span> <span class="nf">sir_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S_tm1</span><span class="p">,</span> <span class="n">I_tm1</span><span class="p">,</span> <span class="n">stringency_level_tmk</span><span class="p">,</span> <span class="n">num_vaccines_available_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates SIR infection model in the US.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intercepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_intercepts</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta_intercepts_modulation</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_slopes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta_slopes_modulation</span>
        <span class="n">beta_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">intercepts</span> <span class="o">+</span> <span class="n">slopes</span> <span class="o">*</span> <span class="n">stringency_level_tmk</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>

        <span class="n">small_number</span> <span class="o">=</span> <span class="mf">1e-10</span>  <span class="c1"># used to prevent indeterminate cases</span>
        <span class="n">susceptible_fraction_vaccinated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_us_states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">),</span>
            <span class="n">num_vaccines_available_t</span> <span class="o">/</span> <span class="p">(</span><span class="n">S_tm1</span> <span class="o">+</span> <span class="n">small_number</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>
        <span class="n">vaccinated_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">num_vaccines_available_t</span><span class="p">,</span> <span class="n">S_tm1</span><span class="p">)</span>

        <span class="c1"># Record R0</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">beta_i</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;R0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># S -&gt; I; dS</span>
        <span class="n">neighborhood_SI_over_N</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_tm1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">)</span> <span class="o">*</span> <span class="n">I_tm1</span>
        <span class="n">dS_t</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">beta_i</span> <span class="o">*</span> <span class="n">neighborhood_SI_over_N</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">susceptible_fraction_vaccinated</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">vaccinated_t</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="c1"># I -&gt; R; dR</span>
        <span class="n">dR_t</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">I_tm1</span> <span class="o">+</span> <span class="n">vaccinated_t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="c1"># dI from d(S + I + R) = 0</span>
        <span class="c1"># ------------------------</span>
        <span class="n">dI_t</span> <span class="o">=</span> <span class="o">-</span><span class="n">dS_t</span> <span class="o">-</span> <span class="n">dR_t</span>

        <span class="n">dV_t</span> <span class="o">=</span> <span class="n">vaccinated_t</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dS_t</span><span class="p">,</span> <span class="n">dI_t</span><span class="p">,</span> <span class="n">dR_t</span><span class="p">,</span> <span class="n">dV_t</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.load_model_constants"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.load_model_constants">[docs]</a>    <span class="k">def</span> <span class="nf">load_model_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_model_constants</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;model_constants.json&quot;</span>
        <span class="k">assert</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_model_constants</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Unable to locate &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">Please run the &quot;</span>
            <span class="s2">&quot;&#39;gather_real_world_data.ipynb&#39; notebook first&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">path_to_model_constants</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_model_constants</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">model_constants_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span> <span class="o">=</span> <span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;DATE_FORMAT&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">us_state_idx_to_state_name</span> <span class="o">=</span> <span class="n">model_constants_dict</span><span class="p">[</span>
            <span class="s2">&quot;US_STATE_IDX_TO_STATE_NAME&quot;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">(</span>
            <span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;US_STATE_POPULATION&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">us_population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">(</span><span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;US_POPULATION&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_stringency_levels</span> <span class="o">=</span> <span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;NUM_STRINGENCY_LEVELS&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">death_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span><span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;SIR_MORTALITY&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span><span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;SIR_GAMMA&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdp_per_capita</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">model_constants_dict</span><span class="p">[</span><span class="s2">&quot;GDP_PER_CAPITA&quot;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.load_fitted_params"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.load_fitted_params">[docs]</a>    <span class="k">def</span> <span class="nf">load_fitted_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_fitted_params</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;fitted_params.json&quot;</span>
        <span class="k">assert</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_fitted_params</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Unable to locate &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">If you ran the &quot;</span>
            <span class="s2">&quot;&#39;gather_real_world_data.ipynb&#39; notebook to download the latest &quot;</span>
            <span class="s2">&quot;real-world data, please also run the &quot;</span>
            <span class="s2">&quot;&#39;fit_parameters.ipynb&#39; notebook.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">path_to_fitted_params</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_fitted_params</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fitted_params_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;POLICY_START_DATE&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_of_life</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">(</span><span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;VALUE_OF_LIFE&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">(</span><span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;BETA_DELAY&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;BETA_SLOPES&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_intercepts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;BETA_INTERCEPTS&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_agent_health_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MIN_MARGINAL_AGENT_HEALTH_INDEX&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_agent_health_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MAX_MARGINAL_AGENT_HEALTH_INDEX&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_agent_economic_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MIN_MARGINAL_AGENT_ECONOMIC_INDEX&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_agent_economic_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MAX_MARGINAL_AGENT_ECONOMIC_INDEX&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_planner_health_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MIN_MARGINAL_PLANNER_HEALTH_INDEX&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_planner_health_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MAX_MARGINAL_PLANNER_HEALTH_INDEX&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_marginal_planner_economic_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MIN_MARGINAL_PLANNER_ECONOMIC_INDEX&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_planner_economic_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;MAX_MARGINAL_PLANNER_ECONOMIC_INDEX&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inferred_weightage_on_agent_health_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;INFERRED_WEIGHTAGE_ON_AGENT_HEALTH_INDEX&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inferred_weightage_on_planner_health_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;INFERRED_WEIGHTAGE_ON_PLANNER_HEALTH_INDEX&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_int_dtype</span><span class="p">(</span><span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;FILTER_LEN&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_lambdas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;CONV_LAMBDAS&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unemployment_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;UNEMPLOYMENT_BIAS&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grouped_convolutional_filter_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">fitted_params_dict</span><span class="p">[</span><span class="s2">&quot;GROUPED_CONVOLUTIONAL_FILTER_WEIGHTS&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">np_float_dtype</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CovidAndEconomyEnvironment.scenario_metrics"><a class="viewcode-back" href="../../../../foundation.scenarios.covid19.html#foundation.scenarios.covid19.covid19_env.CovidAndEconomyEnvironment.scenario_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">scenario_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># End of episode metrics</span>
        <span class="c1"># ----------------------</span>
        <span class="n">metrics_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># State-level metrics</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">state_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_state_idx_to_state_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;infected&quot;</span><span class="p">,</span> <span class="s2">&quot;recovered&quot;</span><span class="p">,</span> <span class="s2">&quot;deaths&quot;</span><span class="p">]:</span>
                <span class="n">metric_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> (millions)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">metrics_dict</span><span class="p">[</span><span class="n">metric_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Total &quot;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()]</span> <span class="o">/</span> <span class="mf">1e6</span>
                <span class="p">)</span>

            <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/mean_unemployment_rate (%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Unemployed&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_state_population</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                <span class="o">*</span> <span class="mi">100</span>
            <span class="p">)</span>

            <span class="n">metrics_dict</span><span class="p">[</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/mean_open_close_stringency_level&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Stringency Level&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

            <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/total_productivity (billion $)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mf">1e9</span>
            <span class="p">)</span>

            <span class="n">metrics_dict</span><span class="p">[</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/health_index_at_end_of_episode&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Health Index&quot;</span><span class="p">]</span>
            <span class="n">metrics_dict</span><span class="p">[</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/economic_index_at_end_of_episode&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;Economic Index&quot;</span><span class="p">]</span>

        <span class="c1"># USA-level metrics</span>
        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/vaccinated (</span><span class="si">% o</span><span class="s2">f population)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Vaccinated&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_population</span>
            <span class="o">*</span> <span class="mi">100</span>
        <span class="p">)</span>
        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/deaths (thousands)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Deaths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">timestep</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span>
        <span class="p">)</span>

        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/mean_unemployment_rate (%)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Unemployed&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">us_population</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">100</span>
        <span class="p">)</span>
        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/total_amount_subsidized (trillion $)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Subsidy&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e12</span>
        <span class="p">)</span>
        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/total_productivity (trillion $)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">global_state</span><span class="p">[</span><span class="s2">&quot;Postsubsidy Productivity&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="o">/</span> <span class="mf">1e12</span>
        <span class="p">)</span>

        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/health_index_at_end_of_episode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span>
            <span class="s2">&quot;Health Index&quot;</span>
        <span class="p">]</span>
        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;usa/economic_index_at_end_of_episode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">state</span><span class="p">[</span>
            <span class="s2">&quot;Economic Index&quot;</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">metrics_dict</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, a.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>