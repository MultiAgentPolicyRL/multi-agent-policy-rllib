<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>foundation.components.redistribution &mdash; ai-economist foundation  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> ai-economist foundation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">foundation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ai-economist foundation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../foundation.html">foundation</a> &raquo;</li>
      <li>foundation.components.redistribution</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for foundation.components.redistribution</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2020, salesforce.com, inc.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: BSD-3-Clause</span>
<span class="c1"># For full license text, see the LICENSE file in the repo root</span>
<span class="c1"># or https://opensource.org/licenses/BSD-3-Clause</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">ai_economist.foundation.base.base_component</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseComponent</span><span class="p">,</span>
    <span class="n">component_registry</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ai_economist.foundation.components.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">annealed_tax_limit</span><span class="p">,</span>
    <span class="n">annealed_tax_mask</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="WealthRedistribution"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.WealthRedistribution">[docs]</a><span class="nd">@component_registry</span><span class="o">.</span><span class="n">add</span>
<span class="k">class</span> <span class="nc">WealthRedistribution</span><span class="p">(</span><span class="n">BaseComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Redistributes the total coin of the mobile agents as evenly as possible.</span>

<span class="sd">    Note:</span>
<span class="sd">        If this component is used, it should always be the last component in the order!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;WealthRedistribution&quot;</span>
    <span class="n">required_entities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span>
    <span class="n">agent_subclasses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BasicMobileAgent&quot;</span><span class="p">]</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Required methods for implementing components</span>
<span class="sd">    --------------------------------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WealthRedistribution.get_n_actions"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.WealthRedistribution.get_n_actions">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_cls_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This component is passive: it does not add any actions.&quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="WealthRedistribution.get_additional_state_fields"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.WealthRedistribution.get_additional_state_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_additional_state_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_cls_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This component does not add any state fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="WealthRedistribution.component_step"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.WealthRedistribution.component_step">[docs]</a>    <span class="k">def</span> <span class="nf">component_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        Redistributes inventory coins so that all agents have equal coin endowment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>

        <span class="c1"># Divide coins evenly</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;inventory&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">])</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;escrow&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">])</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ic</span> <span class="o">+</span> <span class="n">ec</span><span class="p">)</span>
        <span class="n">target_share</span> <span class="o">=</span> <span class="n">tc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;inventory&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target_share</span> <span class="o">-</span> <span class="n">ec</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>

        <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;inventory&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">])</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;escrow&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">])</span>
        <span class="n">tc_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ic</span> <span class="o">+</span> <span class="n">ec</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tc</span> <span class="o">-</span> <span class="n">tc_next</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="WealthRedistribution.generate_observations"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.WealthRedistribution.generate_observations">[docs]</a>    <span class="k">def</span> <span class="nf">generate_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This component does not add any observations.&quot;&quot;&quot;</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="WealthRedistribution.generate_masks"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.WealthRedistribution.generate_masks">[docs]</a>    <span class="k">def</span> <span class="nf">generate_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completions</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Passive component. Masks are empty.&quot;&quot;&quot;</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">masks</span></div></div>


<div class="viewcode-block" id="PeriodicBracketTax"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax">[docs]</a><span class="nd">@component_registry</span><span class="o">.</span><span class="n">add</span>
<span class="k">class</span> <span class="nc">PeriodicBracketTax</span><span class="p">(</span><span class="n">BaseComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Periodically collect income taxes from agents and do lump-sum redistribution.</span>

<span class="sd">    Note:</span>
<span class="sd">        If this component is used, it should always be the last component in the order!</span>

<span class="sd">    Args:</span>
<span class="sd">        disable_taxes (bool): Whether to disable any tax collection, effectively</span>
<span class="sd">            enforcing that tax rates are always 0. Useful for removing taxes without</span>
<span class="sd">            changing the observation space. Default is False (taxes enabled).</span>
<span class="sd">        tax_model (str): Which tax model to use for setting taxes.</span>
<span class="sd">            &quot;model_wrapper&quot; (default) uses the actions of the planner agent;</span>
<span class="sd">            &quot;saez&quot; uses an adaptation of the theoretical optimal taxation formula</span>
<span class="sd">            derived in https://www.nber.org/papers/w7628.</span>
<span class="sd">            &quot;us-federal-single-filer-2018-scaled&quot; uses US federal tax rates from 2018;</span>
<span class="sd">            &quot;fixed-bracket-rates&quot; uses the rates supplied in fixed_bracket_rates.</span>
<span class="sd">        period (int): Length of a tax period in environment timesteps. Taxes are</span>
<span class="sd">            updated at the start of each period and collected/redistributed at the</span>
<span class="sd">            end of each period. Must be &gt; 0. Default is 100 timesteps.</span>
<span class="sd">        rate_min (float): Minimum tax rate within a bracket. Must be &gt;= 0 (default).</span>
<span class="sd">        rate_max (float): Maximum tax rate within a bracket. Must be &lt;= 1 (default).</span>
<span class="sd">        rate_disc (float): (Only applies for &quot;model_wrapper&quot;) the interval separating</span>
<span class="sd">            discrete tax rates that the planner can select. Default of 0.05 means,</span>
<span class="sd">            for example, the planner can select among [0.0, 0.05, 0.10, ... 1.0].</span>
<span class="sd">            Must be &gt; 0 and &lt; 1.</span>
<span class="sd">        n_brackets (int): How many tax brackets to use. Must be &gt;=2. Default is 5.</span>
<span class="sd">        top_bracket_cutoff (float): The income at the left end of the last tax</span>
<span class="sd">            bracket. Must be &gt;= 10. Default is 100 coin.</span>
<span class="sd">        usd_scaling (float): Scale by which to divide the US Federal bracket cutoffs</span>
<span class="sd">            when using bracket_spacing = &quot;us-federal&quot;. Must be &gt; 0. Default is 1000.</span>
<span class="sd">        bracket_spacing (str): How bracket cutoffs should be spaced.</span>
<span class="sd">            &quot;us-federal&quot; (default) uses scaled cutoffs from the 2018 US Federal</span>
<span class="sd">                taxes, with scaling set by usd_scaling (ignores n_brackets and</span>
<span class="sd">                top_bracket_cutoff);</span>
<span class="sd">            &quot;linear&quot; linearly spaces the n_bracket cutoffs between 0 and</span>
<span class="sd">                top_bracket_cutoff;</span>
<span class="sd">            &quot;log&quot; is similar to &quot;linear&quot; but with logarithmic spacing.</span>
<span class="sd">        fixed_bracket_rates (list): Required if tax_model==&quot;fixed-bracket-rates&quot;. A</span>
<span class="sd">            list of fixed marginal rates to use for each bracket. Length must be</span>
<span class="sd">            equal to the number of brackets (7 for &quot;us-federal&quot; spacing, n_brackets</span>
<span class="sd">            otherwise).</span>
<span class="sd">        pareto_weight_type (str): Type of Pareto weights to use when computing tax</span>
<span class="sd">            rates using the Saez formula. &quot;inverse_income&quot; (default) uses 1/z;</span>
<span class="sd">            &quot;uniform&quot; uses 1.</span>
<span class="sd">        saez_fixed_elas (float, optional): If supplied, this value will be used as</span>
<span class="sd">            the elasticity estimate when computing tax rates using the Saez formula.</span>
<span class="sd">            If not given (default), elasticity will be estimated empirically.</span>
<span class="sd">        tax_annealing_schedule (list, optional): A length-2 list of</span>
<span class="sd">            [tax_annealing_warmup, tax_annealing_slope] describing the tax annealing</span>
<span class="sd">            schedule. See annealed_tax_mask function for details. Default behavior is</span>
<span class="sd">            no tax annealing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;PeriodicBracketTax&quot;</span>
    <span class="n">component_type</span> <span class="o">=</span> <span class="s2">&quot;PeriodicTax&quot;</span>
    <span class="n">required_entities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span>
    <span class="n">agent_subclasses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BasicMobileAgent&quot;</span><span class="p">,</span> <span class="s2">&quot;BasicPlanner&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">base_component_args</span><span class="p">,</span>
        <span class="n">disable_taxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">tax_model</span><span class="o">=</span><span class="s2">&quot;model_wrapper&quot;</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">rate_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">rate_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">rate_disc</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">n_brackets</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">top_bracket_cutoff</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">usd_scaling</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
        <span class="n">bracket_spacing</span><span class="o">=</span><span class="s2">&quot;us-federal&quot;</span><span class="p">,</span>
        <span class="n">fixed_bracket_rates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pareto_weight_type</span><span class="o">=</span><span class="s2">&quot;inverse_income&quot;</span><span class="p">,</span>
        <span class="n">saez_fixed_elas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tax_annealing_schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">base_component_kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">base_component_args</span><span class="p">,</span> <span class="o">**</span><span class="n">base_component_kwargs</span><span class="p">)</span>

        <span class="c1"># Whether to turn off taxes. Disabling taxes will prevent any taxes from</span>
        <span class="c1"># being collected but the observation space will be the same as if taxes were</span>
        <span class="c1"># enabled, which can be useful for controlled tax/no-tax comparisons.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">disable_taxes</span><span class="p">)</span>

        <span class="c1"># How to set taxes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">=</span> <span class="n">tax_model</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;model_wrapper&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us-federal-single-filer-2018-scaled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;saez&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fixed-bracket-rates&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># How many timesteps a tax period lasts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Minimum marginal bracket rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">rate_min</span><span class="p">)</span>
        <span class="c1"># Maximum marginal bracket rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">rate_max</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_min</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>

        <span class="c1"># Interval for discretizing tax rate options</span>
        <span class="c1"># (only applies if tax_model == &quot;model_wrapper&quot;).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_disc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rate_disc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_discretized_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;model_wrapper&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_discretized_rates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rate_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_disc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_disc</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_disc_rates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_disc_rates</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># === income bracket definitions ===</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_brackets</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span> <span class="o">&gt;=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">top_bracket_cutoff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">top_bracket_cutoff</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_bracket_cutoff</span> <span class="o">&gt;=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">usd_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">usd_scaling</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">usd_scale</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_spacing</span> <span class="o">=</span> <span class="n">bracket_spacing</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_spacing</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;us-federal&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_spacing</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_bracket_cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_spacing</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">b0_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_bracket_cutoff</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="mi">2</span>
                    <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">b0_max</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_bracket_cutoff</span><span class="p">),</span>
                        <span class="n">n_brackets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_spacing</span> <span class="o">==</span> <span class="s2">&quot;us-federal&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9700</span><span class="p">,</span> <span class="mi">39475</span><span class="p">,</span> <span class="mi">84200</span><span class="p">,</span> <span class="mi">160725</span><span class="p">,</span> <span class="mi">204100</span><span class="p">,</span> <span class="mi">510300</span><span class="p">])</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">usd_scale</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_bracket_cutoff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;us-federal-single-filer-2018-scaled&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_spacing</span> <span class="o">==</span> <span class="s2">&quot;us-federal&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;fixed-bracket-rates&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fixed_bracket_rates</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fixed_bracket_rates</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fixed_bracket_rates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixed_bracket_rates</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_bracket_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fixed_bracket_rates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_bracket_rates</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># === bracket tax rates ===</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span><span class="p">)]</span>

        <span class="c1"># === Pareto weights, elasticity ===</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pareto_weight_type</span> <span class="o">=</span> <span class="n">pareto_weight_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_tm1</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_t</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_z0_tm1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_z0_t</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span> <span class="o">=</span> <span class="n">saez_fixed_elas</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="c1"># Size of the local buffer. In a distributed context, the global buffer size</span>
        <span class="c1"># will be capped at n_replicas * _buffer_size.</span>
        <span class="c1"># NOTE: Saez will use random taxes until it has self._buffer_size samples.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reached_min_samples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additions_this_episode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Local buffer maintained by this replica.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># &quot;Global&quot; buffer obtained by combining local buffers of individual replicas.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_saez_buffer</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_saez_n_estimation_bins</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saez_top_rate_cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saez_top_rate_cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saez_n_estimation_bins</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_avg_tax_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span><span class="p">)</span>

        <span class="c1"># === tax cycle definitions ===</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_coin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_income</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_marginal_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_effective_tax_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>

        <span class="c1"># === trackers ===</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_collected_taxes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_effective_tax_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedules</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taxes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># === tax annealing ===</span>
        <span class="c1"># for annealing of non-planner max taxes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annealed_rate_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_completions</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># for annealing of planner actions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span> <span class="o">=</span> <span class="n">tax_annealing_schedule</span>
        <span class="k">if</span> <span class="n">tax_annealing_schedule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_warmup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annealed_rate_max</span> <span class="o">=</span> <span class="n">annealed_tax_limit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_completions</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_warmup</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_slope</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_warmup</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_slope</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;model_wrapper&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
            <span class="n">planner_action_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_n_actions</span><span class="p">(</span><span class="s2">&quot;BasicPlanner&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_planner_tax_val_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">planner_action_tuples</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_planner_tax_val_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># === placeholders ===</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curr_rates_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_income</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs_sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># Methods for getting/setting marginal tax rates</span>
    <span class="c1"># ----------------------------------------------</span>

    <span class="c1"># ------- US Federal taxes</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">us_federal_single_filer_2018_scaled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        https://turbotax.intuit.com/tax-tips/irs-tax-return/current-federal-tax-rate-schedules/L7Bjs1EAD</span>
<span class="sd">        If taxable income is over—</span>
<span class="sd">        but not over—</span>
<span class="sd">        the tax is:</span>
<span class="sd">        $0</span>
<span class="sd">        $9,700</span>
<span class="sd">        10% of the amount over $0</span>
<span class="sd">        $9,700</span>
<span class="sd">        $39,475</span>
<span class="sd">        $970 plus 12% of the amount over $9,700</span>
<span class="sd">        $39,475</span>
<span class="sd">        $84,200</span>
<span class="sd">        $4,543 plus 22% of the amount over $39,475</span>
<span class="sd">        $84,200</span>
<span class="sd">        $160,725</span>
<span class="sd">        $14,382 plus 24% of the amount over $84,200</span>
<span class="sd">        $160,725</span>
<span class="sd">        $204,100</span>
<span class="sd">        $32,748 plus 32% of the amount over $160,725</span>
<span class="sd">        $204,100</span>
<span class="sd">        $510,300</span>
<span class="sd">        $46,628 plus 35% of the amount over $204,100</span>
<span class="sd">        $510,300</span>
<span class="sd">        no limit</span>
<span class="sd">        $153,798 plus 37% of the amount over $510,300</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.37</span><span class="p">]</span>

    <span class="c1"># ------- fixed-bracket-rates</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fixed_bracket_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whatever fixed bracket rates were set during initialization.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_bracket_rates</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">curr_rate_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximum allowable tax rate, given current progress of any tax annealing.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annealed_rate_max</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">curr_marginal_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The current set of marginal tax bracket rates.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_discretized_rates</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_rates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;us-federal-single-filer-2018-scaled&quot;</span><span class="p">:</span>
            <span class="n">marginal_tax_bracket_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">us_federal_single_filer_2018_scaled</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_max</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;saez&quot;</span><span class="p">:</span>
            <span class="n">marginal_tax_bracket_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_max</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;fixed-bracket-rates&quot;</span><span class="p">:</span>
            <span class="n">marginal_tax_bracket_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed_bracket_rates</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_max</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">return</span> <span class="n">marginal_tax_bracket_rates</span>

<div class="viewcode-block" id="PeriodicBracketTax.set_new_period_rates_model"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.set_new_period_rates_model">[docs]</a>    <span class="k">def</span> <span class="nf">set_new_period_rates_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update taxes using actions from the tax model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># AI version</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bracket</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">):</span>
            <span class="n">planner_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">get_component_action</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;TaxIndexBracket_</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bracket</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">planner_action</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">planner_action</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_disc_rates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">planner_action</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span></div>

    <span class="c1"># ------- Saez formula</span>
<div class="viewcode-block" id="PeriodicBracketTax.compute_and_set_new_period_rates_from_saez_formula"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.compute_and_set_new_period_rates_from_saez_formula">[docs]</a>    <span class="k">def</span> <span class="nf">compute_and_set_new_period_rates_from_saez_formula</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update_elas_tm1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_log_z0_tm1</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimates/sets optimal rates using adaptation of Saez formula</span>

<span class="sd">        See: https://www.nber.org/papers/w7628</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Until we reach the min sample number, keep checking if we have reached it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reached_min_samples</span><span class="p">:</span>
            <span class="c1"># Note: self.saez_buffer includes the global buffer (if applicable).</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saez_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reached_min_samples</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If no enough samples, use random taxes.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reached_min_samples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                <span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_min</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_max</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">incomes_and_marginal_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saez_buffer</span><span class="p">)</span>

        <span class="c1"># Elasticity assumed constant for all incomes.</span>
        <span class="c1"># (Run this for the sake of tracking the estimate; will not actually use the</span>
        <span class="c1"># estimate if using fixed elasticity).</span>
        <span class="k">if</span> <span class="n">update_elas_tm1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elas_tm1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_log_z0_tm1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_z0_tm1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_z0_t</span><span class="p">)</span>

        <span class="n">elas_t</span><span class="p">,</span> <span class="n">log_z0_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_uniform_income_elasticity</span><span class="p">(</span>
            <span class="n">incomes_and_marginal_rates</span><span class="p">,</span>
            <span class="n">elas_df</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
            <span class="n">elas_tm1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_tm1</span><span class="p">,</span>
            <span class="n">log_z0_tm1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_z0_tm1</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">update_elas_tm1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elas_t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elas_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_log_z0_tm1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_z0_t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_z0_t</span><span class="p">)</span>

        <span class="c1"># If a fixed estimate has been specified, use it in the formulas below.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">elas_t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saez_fixed_elas</span><span class="p">)</span>

        <span class="c1"># Get Saez parameters at each income bin</span>
        <span class="c1"># to compute a marginal tax rate schedule.</span>
        <span class="n">binned_gzs</span><span class="p">,</span> <span class="n">binned_azs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_binned_saez_welfare_weight_and_pareto_params</span><span class="p">(</span>
            <span class="n">population_incomes</span><span class="o">=</span><span class="n">incomes_and_marginal_rates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Use the elasticity to compute this binned schedule using the Saez formula.</span>
        <span class="n">binned_marginal_tax_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_saez_marginal_rates</span><span class="p">(</span>
            <span class="n">binned_gzs</span><span class="p">,</span> <span class="n">binned_azs</span><span class="p">,</span> <span class="n">elas_t</span>
        <span class="p">)</span>

        <span class="c1"># Adapt the saez tax schedule to the tax brackets.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bracketize_schedule</span><span class="p">(</span>
                <span class="n">bin_marginal_rates</span><span class="o">=</span><span class="n">binned_marginal_tax_rates</span><span class="p">,</span>
                <span class="n">bin_edges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_edges</span><span class="p">,</span>
                <span class="n">bin_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_sizes</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_min</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_max</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running_avg_tax_rates</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_avg_tax_rates</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="p">)</span></div>

    <span class="c1"># Implementation of the Saez formula in this periodic, bracketed setting</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saez_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_saez_buffer</span><span class="p">:</span>
            <span class="n">saez_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additions_this_episode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">saez_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_saez_buffer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saez_buffer</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_global_saez_buffer</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_additions_this_episode</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">saez_buffer</span>

<div class="viewcode-block" id="PeriodicBracketTax.get_local_saez_buffer"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_local_saez_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">get_local_saez_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.set_global_saez_buffer"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.set_global_saez_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">set_global_saez_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_saez_buffer</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">global_saez_buffer</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">global_saez_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_saez_buffer</span> <span class="o">=</span> <span class="n">global_saez_buffer</span></div>

    <span class="k">def</span> <span class="nf">_update_saez_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tax_info_t</span><span class="p">):</span>
        <span class="c1"># Update the buffer.</span>
        <span class="k">for</span> <span class="n">a_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">):</span>
            <span class="n">z_t</span> <span class="o">=</span> <span class="n">tax_info_t</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a_idx</span><span class="p">)][</span><span class="s2">&quot;income&quot;</span><span class="p">]</span>
            <span class="n">tau_t</span> <span class="o">=</span> <span class="n">tax_info_t</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a_idx</span><span class="p">)][</span><span class="s2">&quot;marginal_rate&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">z_t</span><span class="p">,</span> <span class="n">tau_t</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_additions_this_episode</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_size</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="PeriodicBracketTax.reset_saez_buffers"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.reset_saez_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">reset_saez_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_saez_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_saez_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additions_this_episode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reached_min_samples</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.estimate_uniform_income_elasticity"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.estimate_uniform_income_elasticity">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_uniform_income_elasticity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">observed_incomes_and_marginal_rates</span><span class="p">,</span>
        <span class="n">elas_df</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
        <span class="n">elas_tm1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">log_z0_tm1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate elasticity using Ordinary Least Squares regression.</span>
<span class="sd">        OLS: https://en.wikipedia.org/wiki/Ordinary_least_squares</span>
<span class="sd">        Estimating elasticity: https://www.nber.org/papers/w7512</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">z_t</span><span class="p">,</span> <span class="n">tau_t</span> <span class="ow">in</span> <span class="n">observed_incomes_and_marginal_rates</span><span class="p">:</span>
            <span class="c1"># If z_t is &lt;=0 or tau_t is &gt;=1, the operations below will give us nans</span>
            <span class="k">if</span> <span class="n">z_t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tau_t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_t</span><span class="p">)</span>
                <span class="n">taus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau_t</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">elas_tm1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_z0_tm1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">taus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">elas_tm1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_z0_tm1</span><span class="p">)</span>

        <span class="c1"># Regressing log income against log 1-marginal_rate.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">taus</span><span class="p">),</span> <span class="mf">1e-9</span><span class="p">))</span>
        <span class="c1"># (bias term)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Perform OLS.</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Stack linear &amp; bias terms</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="mf">1e-9</span><span class="p">))</span>  <span class="c1"># Regression targets</span>
        <span class="n">XXi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">XY</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">elas</span><span class="p">,</span> <span class="n">log_z0</span> <span class="o">=</span> <span class="n">XXi</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XY</span><span class="p">)</span>

        <span class="n">warn_less_than_0</span> <span class="o">=</span> <span class="n">elas</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">instant_elas_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">elas</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="n">elas_t</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">elas_df</span><span class="p">)</span> <span class="o">*</span> <span class="n">instant_elas_t</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">elas_df</span> <span class="o">*</span> <span class="n">elas_tm1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn_less_than_0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING: Recent elasticity estimate is &lt; 0.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running elasticity estimate: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elas_t</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running elasticity estimate: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elas_t</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">elas_t</span><span class="p">,</span> <span class="n">log_z0</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.get_binned_saez_welfare_weight_and_pareto_params"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_binned_saez_welfare_weight_and_pareto_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_binned_saez_welfare_weight_and_pareto_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population_incomes</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="k">def</span> <span class="nf">bin_z</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_cumul</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">incomes_below</span><span class="p">,</span> <span class="n">incomes_above</span><span class="p">):</span>
            <span class="n">n_below</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">incomes_below</span><span class="p">)</span>
            <span class="n">n_above</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">incomes_above</span><span class="p">)</span>
            <span class="n">n_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_below</span> <span class="o">+</span> <span class="n">n_above</span>

            <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_total</span>

            <span class="c1"># Probability that an income is below the taxable threshold.</span>
            <span class="n">p_below</span> <span class="o">=</span> <span class="n">n_below</span> <span class="o">/</span> <span class="n">n_total</span>

            <span class="c1"># pz = p(z&#39; = z): probability that [binned] income z&#39; occurs in bin z.</span>
            <span class="n">pz</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n_above</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">]</span>

            <span class="c1"># Pz = p(z&#39; &lt;= z): Probability z&#39; is less-than or equal to z.</span>
            <span class="n">cum_pz</span> <span class="o">=</span> <span class="p">[</span><span class="n">pz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p_below</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pz</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">cum_pz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">cum_pz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pz</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cum_pz</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compute_binned_g_distribution</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">lefts</span><span class="p">,</span> <span class="n">incomes</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">pareto</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_weight_type</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
                    <span class="n">pareto_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pareto_weight_type</span> <span class="o">==</span> <span class="s2">&quot;inverse_income&quot;</span><span class="p">:</span>
                    <span class="n">pareto_weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="k">return</span> <span class="n">pareto_weights</span>

            <span class="n">incomes_below</span> <span class="o">=</span> <span class="n">incomes</span><span class="p">[</span><span class="n">incomes</span> <span class="o">&lt;</span> <span class="n">lefts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">incomes_above</span> <span class="o">=</span> <span class="n">incomes</span><span class="p">[</span><span class="n">incomes</span> <span class="o">&gt;</span> <span class="n">lefts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="c1"># The total (unnormalized) Pareto weight of untaxable incomes.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">incomes_below</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pareto_weight_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pareto</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">incomes_below</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pareto_weight_below</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># The total (unnormalized) Pareto weight within each bin.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">incomes_above</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pareto_weight_above</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pareto</span><span class="p">(</span><span class="n">incomes_above</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pareto_weight_above</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># The total (unnormalized) Pareto weight within each bin.</span>
            <span class="n">pareto_weight_per_bin</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">*</span> <span class="n">pareto</span><span class="p">(</span><span class="n">bin_z</span><span class="p">(</span><span class="n">lefts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lefts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

            <span class="c1"># The aggregate (unnormalized) Pareto weight of all incomes.</span>
            <span class="n">cumulative_pareto_weights</span> <span class="o">=</span> <span class="n">pareto_weight_per_bin</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">cumulative_pareto_weights</span> <span class="o">+=</span> <span class="n">pareto_weight_below</span>
            <span class="n">cumulative_pareto_weights</span> <span class="o">+=</span> <span class="n">pareto_weight_above</span>

            <span class="c1"># Normalize so that the Pareto density sums to 1.</span>
            <span class="n">pareto_norm</span> <span class="o">=</span> <span class="n">cumulative_pareto_weights</span> <span class="o">+</span> <span class="mf">1e-9</span>
            <span class="n">unnormalized_pareto_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pareto_weight_per_bin</span><span class="p">,</span> <span class="p">[</span><span class="n">pareto_weight_above</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="n">normalized_pareto_density</span> <span class="o">=</span> <span class="n">unnormalized_pareto_density</span> <span class="o">/</span> <span class="n">pareto_norm</span>

            <span class="c1"># Aggregate Pareto weight of earners with income greater-than or equal to z.</span>
            <span class="n">cumulative_pareto_density_geq_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                <span class="n">normalized_pareto_density</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Probability that [binned] income z&#39; is greather-than or equal to z.</span>
            <span class="n">pz</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_cumul</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">incomes_below</span><span class="p">,</span> <span class="n">incomes_above</span><span class="p">)</span>
            <span class="n">cumulative_prob_geq_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pz</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Average (normalized) Pareto weight of earners with income &gt;= z.</span>
            <span class="n">geq_z_norm</span> <span class="o">=</span> <span class="n">cumulative_prob_geq_z</span> <span class="o">+</span> <span class="mf">1e-9</span>
            <span class="n">avg_pareto_weight_geq_z</span> <span class="o">=</span> <span class="n">cumulative_pareto_density_geq_z</span> <span class="o">/</span> <span class="n">geq_z_norm</span>

            <span class="k">def</span> <span class="nf">interpolate_gzs</span><span class="p">(</span><span class="n">gz</span><span class="p">):</span>
                <span class="c1"># Assume incomes within a bin are evenly distributed within that bin</span>
                <span class="c1"># and re-compute accordingly.</span>
                <span class="n">gz_at_left_edge</span> <span class="o">=</span> <span class="n">gz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">gz_at_right_edge</span> <span class="o">=</span> <span class="n">gz</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="n">avg_bin_gz</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">gz_at_left_edge</span> <span class="o">+</span> <span class="n">gz_at_right_edge</span><span class="p">)</span>
                <span class="c1"># Re-attach the gz of the top tax rate (does not need to be</span>
                <span class="c1"># interpolated).</span>
                <span class="n">gzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">avg_bin_gz</span><span class="p">,</span> <span class="p">[</span><span class="n">gz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
                <span class="k">return</span> <span class="n">gzs</span>

            <span class="k">return</span> <span class="n">interpolate_gzs</span><span class="p">(</span><span class="n">avg_pareto_weight_geq_z</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compute_binned_a_distribution</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">lefts</span><span class="p">,</span> <span class="n">incomes</span><span class="p">):</span>
            <span class="n">incomes_below</span> <span class="o">=</span> <span class="n">incomes</span><span class="p">[</span><span class="n">incomes</span> <span class="o">&lt;</span> <span class="n">lefts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">incomes_above</span> <span class="o">=</span> <span class="n">incomes</span><span class="p">[</span><span class="n">incomes</span> <span class="o">&gt;</span> <span class="n">lefts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="c1"># z is defined as the MIDDLE point in a bin.</span>
            <span class="c1"># So for a bin [left, right] -&gt; z = (left + right) / 2.</span>
            <span class="n">Az</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># cum_pz = p(z&#39; &lt;= z): Probability z&#39; is less-than or equal to z</span>
            <span class="n">pz</span><span class="p">,</span> <span class="n">cum_pz</span> <span class="o">=</span> <span class="n">get_cumul</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">incomes_below</span><span class="p">,</span> <span class="n">incomes_above</span><span class="p">)</span>

            <span class="c1"># Probability z&#39; is greater-than or equal to z</span>
            <span class="c1"># Note: The &quot;0.5&quot; coefficient gives results more consistent with theory; it</span>
            <span class="c1"># accounts for the assumption that incomes within a particular bin are</span>
            <span class="c1"># uniformly spread between the left &amp; right edges of that bin.</span>
            <span class="n">p_geq_z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cum_pz</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">pz</span><span class="p">)</span>

            <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lefts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Az</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">bin_z</span><span class="p">(</span><span class="n">lefts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lefts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># paz = z * pz[i] / (clip(1 - Pz[i], 0, 1) + 1e-9)</span>
                    <span class="n">paz</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">pz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">p_geq_z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>  <span class="c1"># defn of A(z)</span>
                    <span class="n">paz</span> <span class="o">=</span> <span class="n">paz</span> <span class="o">/</span> <span class="p">(</span><span class="n">lefts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lefts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># norm by bin width</span>
                    <span class="n">Az</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paz</span><span class="p">)</span>

            <span class="c1"># Az for the incomes past the top cutoff,</span>
            <span class="c1"># the bin is [left, infinity]: there is no &quot;middle&quot;.</span>
            <span class="c1"># Hence, use the mean value in the last bin.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">incomes_above</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cutoff</span> <span class="o">=</span> <span class="n">lefts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">avg_income_above_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">incomes_above</span><span class="p">)</span>
                <span class="c1"># use a special formula to compute A(z)</span>
                <span class="n">Az_above</span> <span class="o">=</span> <span class="n">avg_income_above_cutoff</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">avg_income_above_cutoff</span> <span class="o">-</span> <span class="n">cutoff</span> <span class="o">+</span> <span class="mf">1e-9</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Az_above</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Az</span><span class="p">,</span> <span class="p">[</span><span class="n">Az_above</span><span class="p">]])</span>

        <span class="n">counts</span><span class="p">,</span> <span class="n">lefts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">population_incomes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_saez_income_bin_edges</span>
        <span class="p">)</span>
        <span class="n">population_gz</span> <span class="o">=</span> <span class="n">compute_binned_g_distribution</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">lefts</span><span class="p">,</span> <span class="n">population_incomes</span><span class="p">)</span>
        <span class="n">population_az</span> <span class="o">=</span> <span class="n">compute_binned_a_distribution</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">lefts</span><span class="p">,</span> <span class="n">population_incomes</span><span class="p">)</span>

        <span class="c1"># Return the binned stats used to create a schedule of marginal rates.</span>
        <span class="k">return</span> <span class="n">population_gz</span><span class="p">,</span> <span class="n">population_az</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.get_saez_marginal_rates"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_saez_marginal_rates">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_saez_marginal_rates</span><span class="p">(</span><span class="n">binned_gz</span><span class="p">,</span> <span class="n">binned_az</span><span class="p">,</span> <span class="n">elas</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Marginal rates within each income bin (last tau is the top tax rate).</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">binned_gz</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">binned_gz</span> <span class="o">+</span> <span class="n">binned_az</span> <span class="o">*</span> <span class="n">elas</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
            <span class="c1"># In bins where there were no incomes found, tau is nan.</span>
            <span class="c1"># Interpolate to fill the gaps.</span>
            <span class="n">last_real_rate</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">last_real_tidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tau</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taus</span><span class="p">):</span>
                <span class="c1"># The current tax rate is a real number.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tau</span><span class="p">):</span>
                    <span class="c1"># This is the end of a gap. Interpolate.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">last_real_tidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span>
                        <span class="p">)</span>  <span class="c1"># This should never trigger for the first tax bin.</span>
                        <span class="n">gap_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">last_real_tidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                        <span class="n">intermediate_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                            <span class="n">last_real_rate</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gap_indices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">gap_indices</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">intermediate_rates</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">gap_index</span><span class="p">,</span> <span class="n">intermediate_rate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">gap_indices</span><span class="p">,</span> <span class="n">intermediate_rates</span>
                        <span class="p">):</span>
                            <span class="n">taus</span><span class="p">[</span><span class="n">gap_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">intermediate_rate</span>
                    <span class="c1"># Update the tracker.</span>
                    <span class="n">last_real_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                    <span class="n">last_real_tidx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="c1"># The current tax rate is a nan. Continue without updating</span>
                <span class="c1"># the tracker (indicating the presence of a gap).</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">taus</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.bracketize_schedule"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.bracketize_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">bracketize_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_marginal_rates</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bin_sizes</span><span class="p">):</span>
        <span class="c1"># Compute the amount of tax each bracket would collect</span>
        <span class="c1"># if income was &gt;= the right edge.</span>
        <span class="c1"># Divide by the bracket size to get</span>
        <span class="c1"># the average marginal rate within that bracket.</span>
        <span class="n">last_bracket_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bracket_avg_marginal_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b_idx</span><span class="p">,</span> <span class="n">income</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="c1"># How much income occurs within each bin</span>
            <span class="c1"># (including the open-ended, top &quot;bin&quot;).</span>
            <span class="n">past_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">)</span>
            <span class="n">bin_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">,</span> <span class="n">past_cutoff</span><span class="p">)</span>

            <span class="c1"># To get the total taxes due,</span>
            <span class="c1"># multiply the income within each bin by that bin&#39;s marginal rate.</span>
            <span class="n">bin_taxes</span> <span class="o">=</span> <span class="n">bin_marginal_rates</span> <span class="o">*</span> <span class="n">bin_income</span>
            <span class="n">taxes_due</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_taxes</span><span class="p">))</span>

            <span class="n">bracket_tax_burden</span> <span class="o">=</span> <span class="n">taxes_due</span> <span class="o">-</span> <span class="n">last_bracket_total</span>
            <span class="n">bracket_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_sizes</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span>

            <span class="n">bracket_avg_marginal_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bracket_tax_burden</span> <span class="o">/</span> <span class="n">bracket_size</span><span class="p">)</span>
            <span class="n">last_bracket_total</span> <span class="o">=</span> <span class="n">taxes_due</span>

        <span class="c1"># The top bracket tax rate is computed directly already.</span>
        <span class="n">bracket_avg_marginal_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bin_marginal_rates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">bracket_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bracket_avg_marginal_rates</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bracket_rates</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span>

        <span class="k">return</span> <span class="n">bracket_rates</span></div>

    <span class="c1"># Methods for collecting and redistributing taxes</span>
    <span class="c1"># -----------------------------------------------</span>

<div class="viewcode-block" id="PeriodicBracketTax.income_bin"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.income_bin">[docs]</a>    <span class="k">def</span> <span class="nf">income_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">income</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return index of tax bin in which income falls.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">income</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">meets_min</span> <span class="o">=</span> <span class="n">income</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">under_max</span> <span class="o">=</span> <span class="n">income</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">bracket_bool</span> <span class="o">=</span> <span class="n">meets_min</span> <span class="o">*</span> <span class="n">under_max</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bracket_bool</span><span class="p">)]</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.marginal_rate"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.marginal_rate">[docs]</a>    <span class="k">def</span> <span class="nf">marginal_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">income</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the marginal tax rate applied at this income level.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">income</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">meets_min</span> <span class="o">=</span> <span class="n">income</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">under_max</span> <span class="o">=</span> <span class="n">income</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">bracket_bool</span> <span class="o">=</span> <span class="n">meets_min</span> <span class="o">*</span> <span class="n">under_max</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bracket_bool</span><span class="p">)]</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.taxes_due"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.taxes_due">[docs]</a>    <span class="k">def</span> <span class="nf">taxes_due</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">income</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total amount of taxes due at this income level.&quot;&quot;&quot;</span>
        <span class="n">past_cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">)</span>
        <span class="n">bin_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_sizes</span><span class="p">,</span> <span class="n">past_cutoff</span><span class="p">)</span>
        <span class="n">bin_taxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span> <span class="o">*</span> <span class="n">bin_income</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_taxes</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.enact_taxes"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.enact_taxes">[docs]</a>    <span class="k">def</span> <span class="nf">enact_taxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate period income &amp; tax burden. Collect taxes and redistribute.&quot;&quot;&quot;</span>
        <span class="n">net_tax_revenue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tax_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">schedule</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span><span class="p">),</span>
            <span class="n">cutoffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">curr_rate</span><span class="p">,</span> <span class="n">bracket_cutoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedules</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bracket_cutoff</span><span class="p">))]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">curr_rate</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_income</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_effective_tax_rate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_marginal_rate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">last_coin</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_coin</span><span class="p">):</span>
            <span class="n">income</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">total_endowment</span><span class="p">(</span><span class="s2">&quot;Coin&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_coin</span>
            <span class="n">tax_due</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxes_due</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
            <span class="n">effective_taxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;inventory&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">],</span> <span class="n">tax_due</span>
            <span class="p">)</span>  <span class="c1"># Don&#39;t take from escrow.</span>
            <span class="n">marginal_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_rate</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
            <span class="n">effective_tax_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">effective_taxes</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.000001</span><span class="p">,</span> <span class="n">income</span><span class="p">))</span>
            <span class="n">tax_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">income</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">income</span><span class="p">),</span>
                <span class="n">tax_paid</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">effective_taxes</span><span class="p">),</span>
                <span class="n">marginal_rate</span><span class="o">=</span><span class="n">marginal_rate</span><span class="p">,</span>
                <span class="n">effective_rate</span><span class="o">=</span><span class="n">effective_tax_rate</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Actually collect the taxes.</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;inventory&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">effective_taxes</span>
            <span class="n">net_tax_revenue</span> <span class="o">+=</span> <span class="n">effective_taxes</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_income</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">income</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_marginal_rate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">marginal_rate</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_effective_tax_rate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">effective_tax_rate</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">all_effective_tax_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">effective_tax_rate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">income_bin</span><span class="p">(</span><span class="n">income</span><span class="p">)))]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_collected_taxes</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">net_tax_revenue</span><span class="p">)</span>

        <span class="n">lump_sum</span> <span class="o">=</span> <span class="n">net_tax_revenue</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;inventory&quot;</span><span class="p">][</span><span class="s2">&quot;Coin&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lump_sum</span>
            <span class="n">tax_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">)][</span><span class="s2">&quot;lump_sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lump_sum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_coin</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">total_endowment</span><span class="p">(</span><span class="s2">&quot;Coin&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">taxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tax_dict</span><span class="p">)</span>

        <span class="c1"># Pre-compute some things that will be useful for generating observations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_income</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs_sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Fold this period&#39;s tax data into the saez buffer.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;saez&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_saez_buffer</span><span class="p">(</span><span class="n">tax_dict</span><span class="p">)</span></div>

    <span class="c1"># Required methods for implementing components</span>
    <span class="c1"># --------------------------------------------</span>

<div class="viewcode-block" id="PeriodicBracketTax.get_n_actions"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_n_actions">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_cls_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        If using the &quot;model_wrapper&quot; tax model and taxes are enabled, the planner&#39;s</span>
<span class="sd">        action space includes an action subspace for each of the tax brackets. Each</span>
<span class="sd">        such action space has as many actions as there are discretized tax rates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Only the planner takes actions through this component.</span>
        <span class="k">if</span> <span class="n">agent_cls_name</span> <span class="o">==</span> <span class="s2">&quot;BasicPlanner&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;model_wrapper&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
                <span class="c1"># For every bracket, the planner can select one of the discretized</span>
                <span class="c1"># tax rates.</span>
                <span class="k">return</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;TaxIndexBracket_</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_disc_rates</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span>
                <span class="p">]</span>

        <span class="c1"># Return 0 (no added actions) if the other conditions aren&#39;t met.</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.get_additional_state_fields"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_additional_state_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_additional_state_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_cls_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This component does not add any agent state fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.component_step"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.component_step">[docs]</a>    <span class="k">def</span> <span class="nf">component_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        On the first day of each tax period, update taxes. On the last day, enact them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1. On the first day of a new tax period: Set up the taxes for this period.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;model_wrapper&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_new_period_rates_model</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;saez&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute_and_set_new_period_rates_from_saez_formula</span><span class="p">()</span>

            <span class="c1"># (cache this for faster obs generation)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_curr_rates_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span><span class="p">)</span>

        <span class="c1"># 2. On the last day of the tax period: Get $-taxes AND update agent endowments.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enact_taxes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taxes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="c1"># increment timestep.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.generate_observations"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.generate_observations">[docs]</a>    <span class="k">def</span> <span class="nf">generate_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        Agents observe where in the tax period cycle they are, information about the</span>
<span class="sd">        last period&#39;s incomes, and the current marginal tax rates, including the</span>
<span class="sd">        marginal rate that will apply to their next unit of income.</span>

<span class="sd">        The planner observes the same type of information, but for all the agents. It</span>
<span class="sd">        also sees, for each agent, their marginal tax rate and reported income from</span>
<span class="sd">        the previous tax period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_tax_day</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
        <span class="n">is_first_day</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tax_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">is_tax_day</span><span class="o">=</span><span class="n">is_tax_day</span><span class="p">,</span>
            <span class="n">is_first_day</span><span class="o">=</span><span class="n">is_first_day</span><span class="p">,</span>
            <span class="n">tax_phase</span><span class="o">=</span><span class="n">tax_phase</span><span class="p">,</span>
            <span class="n">last_incomes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs_sorted</span><span class="p">,</span>
            <span class="n">curr_rates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_curr_rates_obs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">curr_marginal_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_rate</span><span class="p">(</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">total_endowment</span><span class="p">(</span><span class="s2">&quot;Coin&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_coin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">obs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">is_tax_day</span><span class="o">=</span><span class="n">is_tax_day</span><span class="p">,</span>
                <span class="n">is_first_day</span><span class="o">=</span><span class="n">is_first_day</span><span class="p">,</span>
                <span class="n">tax_phase</span><span class="o">=</span><span class="n">tax_phase</span><span class="p">,</span>
                <span class="n">last_incomes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs_sorted</span><span class="p">,</span>
                <span class="n">curr_rates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_curr_rates_obs</span><span class="p">,</span>
                <span class="n">marginal_rate</span><span class="o">=</span><span class="n">curr_marginal_rate</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;p&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">last_income</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">last_marginal_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_marginal_rate</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">curr_marginal_rate</span><span class="o">=</span><span class="n">curr_marginal_rate</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.generate_masks"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.generate_masks">[docs]</a>    <span class="k">def</span> <span class="nf">generate_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completions</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        Masks only apply to the planner and if tax_model == &quot;model_wrapper&quot; and taxes</span>
<span class="sd">        are enabled.</span>
<span class="sd">        All tax actions are masked (so, only NO-OPs can be sampled) on all timesteps</span>
<span class="sd">        except when self.tax_cycle_pos==1 (meaning a new tax period is starting).</span>
<span class="sd">        When self.tax_cycle_pos==1, tax actions are masked in order to enforce any</span>
<span class="sd">        tax annealing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">completions</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_completions</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_completions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">completions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annealed_rate_max</span> <span class="o">=</span> <span class="n">annealed_tax_limit</span><span class="p">(</span>
                <span class="n">completions</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_warmup</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_slope</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rate_max</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;model_wrapper&quot;</span><span class="p">:</span>
            <span class="c1"># No annealing. Generate masks using default method.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_annealing_schedule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">masks</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_masks</span><span class="p">(</span><span class="n">completions</span><span class="o">=</span><span class="n">completions</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">new_taxes</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]),</span>
                        <span class="n">zeros</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># No need to recompute. Use the cached masks.</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
                    <span class="c1"># Apply zero masks for any timestep where taxes</span>
                    <span class="c1"># are not going to be updated.</span>
                    <span class="n">masks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span><span class="p">[</span><span class="s2">&quot;zeros&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">masks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span><span class="p">[</span><span class="s2">&quot;new_taxes&quot;</span><span class="p">]</span>

            <span class="c1"># Doing annealing.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Figure out what the masks should be this episode.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">planner_masks</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">annealed_tax_mask</span><span class="p">(</span>
                            <span class="n">completions</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_warmup</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_annealing_slope</span><span class="p">,</span>
                            <span class="n">tax_values</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tax_values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_tax_val_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">new_taxes</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">planner_masks</span><span class="p">),</span>
                        <span class="n">zeros</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">planner_masks</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                    <span class="p">)</span>

                <span class="c1"># No need to recompute. Use the cached masks.</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
                    <span class="c1"># Apply zero masks for any timestep where taxes</span>
                    <span class="c1"># are not going to be updated.</span>
                    <span class="n">masks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span><span class="p">[</span><span class="s2">&quot;zeros&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">masks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span><span class="p">[</span><span class="s2">&quot;new_taxes&quot;</span><span class="p">]</span>

        <span class="c1"># We are not using a learned planner. Generate masks by the default method.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate_masks</span><span class="p">(</span><span class="n">completions</span><span class="o">=</span><span class="n">completions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">masks</span></div>

    <span class="c1"># For non-required customization</span>
    <span class="c1"># ------------------------------</span>

<div class="viewcode-block" id="PeriodicBracketTax.additional_reset_steps"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.additional_reset_steps">[docs]</a>    <span class="k">def</span> <span class="nf">additional_reset_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        Reset trackers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_rate_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_brackets</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tax_cycle_pos</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_coin</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">total_endowment</span><span class="p">(</span><span class="s2">&quot;Coin&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_income</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_marginal_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_effective_tax_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_agents</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_curr_rates_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_marginal_rates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_income</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs_sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_income_obs</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">taxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_collected_taxes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_effective_tax_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedules</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_planner_masks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;saez&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_bracket_tax_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_avg_tax_rates</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.get_metrics"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See base_component.py for detailed description.</span>

<span class="sd">        Return metrics related to bracket rates, bracket occupancy, and tax collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">n_observed_incomes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_occupancy</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_cutoffs</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;avg_bracket_rate/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schedules</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;bracket_occupancy/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_occupancy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_observed_incomes</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;avg_effective_tax_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_effective_tax_rates</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;total_collected_taxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_collected_taxes</span><span class="p">)</span>

            <span class="c1"># Indices of richest and poorest agents.</span>
            <span class="n">agent_coin_endows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">total_endowment</span><span class="p">(</span><span class="s2">&quot;Coin&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">idx_poor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">agent_coin_endows</span><span class="p">)</span>
            <span class="n">idx_rich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">agent_coin_endows</span><span class="p">)</span>

            <span class="n">tax_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxes</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">::</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">idx_poor</span><span class="p">,</span> <span class="n">idx_rich</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;poorest&quot;</span><span class="p">,</span> <span class="s2">&quot;richest&quot;</span><span class="p">]):</span>
                <span class="n">total_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">tax_day</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s2">&quot;income&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tax_day</span> <span class="ow">in</span> <span class="n">tax_days</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">total_tax_paid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">tax_day</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s2">&quot;tax_paid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tax_day</span> <span class="ow">in</span> <span class="n">tax_days</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Report the overall tax rate over the episode</span>
                <span class="c1"># for the richest and poorest agents.</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;avg_tax_rate/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)]</span> <span class="o">=</span> <span class="n">total_tax_paid</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="mf">0.001</span><span class="p">,</span> <span class="n">total_income</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_model</span> <span class="o">==</span> <span class="s2">&quot;saez&quot;</span><span class="p">:</span>
                <span class="c1"># Include the running estimate of elasticity.</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;saez/estimated_elasticity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_tm1</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="PeriodicBracketTax.get_dense_log"><a class="viewcode-back" href="../../../foundation.components.html#foundation.components.redistribution.PeriodicBracketTax.get_dense_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_dense_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log taxes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            taxes (list): A list of tax collections. Each entry corresponds to a single</span>
<span class="sd">                timestep. Entries are empty except for timesteps where a tax period</span>
<span class="sd">                ended and taxes were collected. For those timesteps, each entry</span>
<span class="sd">                contains the tax schedule, each agent&#39;s reported income, tax paid,</span>
<span class="sd">                and redistribution received.</span>
<span class="sd">                Returns None if taxes are disabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_taxes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">taxes</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, a.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>